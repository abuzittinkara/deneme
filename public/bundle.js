(()=>{"use strict";var e,t,n={427:(e,t,n)=>{n.d(t,{Ij:()=>d,fF:()=>i});let a=null,o=null,r=null;function i(e){r=e,e.on("avatarUpdated",(({username:e,avatar:t})=>{if(a&&o===e){const e=a.querySelector(".popout-avatar");e&&(e.src=t||"/images/default-avatar.png")}}))}async function d(e,t){a&&(a.remove(),a=null,o=null),o=e;const n=window.getAuthToken(),r=await fetch(`/api/user/me?username=${encodeURIComponent(e)}`,{headers:n?{Authorization:`Bearer ${n}`}:void 0});if(!r.ok)return;const i=await r.json(),d=document.createElement("div");d.className="profile-popout";const s=document.createElement("div");s.className="popout-banner",d.appendChild(s);const l=document.createElement("div");l.className="popout-avatar-wrap";const c=document.createElement("img");c.className="popout-avatar",c.src="/images/default-avatar.png",window.loadAvatar(e).then((e=>{c.src=e})),c.alt="",l.appendChild(c);const u=document.createElement("span");u.className="status-dot",l.appendChild(u),d.appendChild(l);const m=document.createElement("div");if(m.className="popout-display-name",m.textContent=i.displayName||e,d.appendChild(m),i.badges&&Array.isArray(i.badges)&&i.badges.length){const e=document.createElement("div");e.className="popout-badges",i.badges.forEach((t=>{const n=document.createElement("span");n.className="badge",n.textContent=t,e.appendChild(n)})),d.appendChild(e)}if(i.ctaLabel){const e=document.createElement("button");e.className="profile-cta-btn",e.textContent=i.ctaLabel,d.appendChild(e)}function p(e){d.contains(e.target)||g()}function w(e){"Escape"===e.key&&g()}function g(){d.parentNode&&d.parentNode.removeChild(d),document.removeEventListener("click",p),document.removeEventListener("keydown",w),a=null,o=null}document.body.appendChild(d),function(e,t,n){const a=e.offsetWidth||300,o=e.offsetHeight||200;let r=t,i=n;r+a>window.innerWidth-10&&(r=window.innerWidth-a-10),i+o>window.innerHeight-10&&(i=window.innerHeight-o-10),e.style.left=`${r}px`,e.style.top=`${i}px`}(d,t.clientX,t.clientY),document.addEventListener("click",p),document.addEventListener("keydown",w),a=d}},17:(e,t,n)=>{n.d(t,{Cp:()=>y,Lb:()=>f,Yt:()=>h,gV:()=>r,hB:()=>s,m4:()=>v,w:()=>E});var a=n(427);let o={};function r(e,t){const n=new Date(e),a=new Date(t);return n.getFullYear()!==a.getFullYear()||n.getMonth()!==a.getMonth()||n.getDate()!==a.getDate()}function i(e){const t=new Date(e),n=new Date,a=new Date(n.getFullYear(),n.getMonth(),n.getDate()),o=new Date(n.getFullYear(),n.getMonth(),n.getDate()-1);return t>=a?"Bugün "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t>=o&&t<a?"Dün "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):`${("0"+t.getDate()).slice(-2)}.${("0"+(t.getMonth()+1)).slice(-2)}.${t.getFullYear()} ${t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}function d(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function s(e,t){const n=document.createElement("div");n.className="date-separator",n.setAttribute("data-timestamp",new Date(t).toISOString()),n.innerHTML=`<span class="separator-text">${function(e){const t=new Date(e);return`${t.getDate()} ${["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"][t.getMonth()]} ${t.getFullYear()}`}(t)}</span>`,e.appendChild(n)}function l(e=[]){return e.length?`\n    <div class="message-attachments">\n      ${e.map((e=>{const t=e.type||"",n=e.url||"",a=e.name||n.split("/").pop(),o=e.size?function(e){if(!e&&0!==e)return"";const t=1048576;return e>=t?`${(e/t).toFixed(1)} MB`:e>=1024?`${(e/1024).toFixed(1)} KB`:`${e} B`}(e.size):"";if(t.startsWith("image/"))return`<img src="${n}" data-lightbox="${n}" alt="${a}">`;if(t.startsWith("video/"))return`<video controls data-lightbox="${n}"><source src="${n}" type="${t}"></video>`;if(t.startsWith("audio/"))return`<audio controls src="${n}"></audio>`;const r=/pdf$/i.test(t)||a.toLowerCase().endsWith(".pdf")?"picture_as_pdf":/(zip|rar|7z)/i.test(t)||a.toLowerCase().match(/\.(zip|rar|7z)$/)?"archive":"insert_drive_file";return`\n            <a class="attachment-wrapper" data-url="${n}" data-name="${a}" tabindex="0">\n              <span class="file-icon ${"picture_as_pdf"===r?"pdf":"archive"===r?"archive":"default"} material-icons">${r}</span>\n              <div class="file-text">\n                <div class="file-name">${a}</div>\n                <div class="file-info">${o}</div>\n              </div>\n            </a>\n          `})).join("")}\n    </div>`:""}function c(e){return e?e.replace(/@([A-Za-z0-9_]+)/g,'<span class="mention">@$1</span>'):""}let u=null;function m(e){"Escape"===e.key&&p()}function p(){u&&(u.style.display="none",u.classList.remove("active"),document.removeEventListener("keydown",m))}function w(e,t,n,a){return`\n    <div class="message-item" style="position: relative;">\n      <span class="delete-icon material-symbols-outlined">delete</span>\n      <div class="message-header">\n        <div class="message-avatar-container">\n          <img class="message-avatar" data-username="${t}" src="/images/default-avatar.png" alt="">\n        </div>\n        <div class="sender-info">\n          <span class="sender-name">${t}</span>\n          <span class="timestamp">${n}</span>\n        </div>\n      </div>\n      <div class="message-content ${a}">${c(e.content)}${l(e.attachments)}</div>\n    </div>\n  `}function g(e,t,n){const a=c(e.content);return`\n    <div class="message-item" style="position: relative;">\n      <span class="hover-time">${d(n)}</span>\n      <span class="delete-icon material-symbols-outlined">delete</span>\n      <div class="message-content ${t}">${a}${l(e.attachments)}</div>\n    </div>\n  `}function y(e,t){t.innerHTML="";let n=null;e.forEach(((a,d)=>{const l=a.user&&a.user.username?a.user.username:"Anon",c=new Date(a.timestamp),u=i(a.timestamp);let m="";n&&!r(n,c)||s(t,a.timestamp),n=c,m=0===d||(e[d-1].user&&e[d-1].user.username)!==l||r(e[d-1].timestamp,a.timestamp)?d===e.length-1||(e[d+1].user&&e[d+1].user.username)!==l||r(a.timestamp,e[d+1].timestamp)?"only-message":"first-message":d===e.length-1||(e[d+1].user&&e[d+1].user.username)!==l||r(a.timestamp,e[d+1].timestamp)?"last-message":"middle-message";let p="";p="only-message"===m||"first-message"===m?w(a,l,u,m):g(a,m,a.timestamp);const y=document.createElement("div");y.className=`text-message ${m}`,y.setAttribute("data-id",a.id||a._id||""),y.setAttribute("data-timestamp",new Date(a.timestamp).toISOString()),y.setAttribute("data-sender",l),l===window.username&&y.classList.add("own-message"),window.loadAvatar(l).then((e=>{const t=y.querySelector(".message-avatar");t&&(t.src=e)})),y.innerHTML=p,t.appendChild(y),o[t.dataset.channelId]={sender:l,timestamp:new Date(a.timestamp),count:1}})),t.scrollTop=t.scrollHeight}function h(e,t){const n=e.username||"Anon",a=i(e.timestamp);let d="last-message";const s=t.scrollTop+t.clientHeight>=t.scrollHeight-20,l=t.querySelectorAll(".text-message");let c=l.length>0?l[l.length-1]:null;if(c&&c.getAttribute("data-sender")===n)if(r(new Date(c.getAttribute("data-timestamp")),e.timestamp))d="only-message";else{c.classList.remove("only-message","first-message","middle-message","last-message"),c.classList.add("middle-message");const e=c.querySelector(".message-content");e&&(e.classList.remove("only-message","first-message","middle-message","last-message"),e.classList.add("middle-message")),d="last-message"}else d="only-message";let u="";u="only-message"===d?w(e,n,a,d):g(e,d,e.timestamp);const m=document.createElement("div");m.setAttribute("data-id",e.id||e._id||""),m.className=`text-message ${d}`,m.setAttribute("data-timestamp",new Date(e.timestamp).toISOString()),m.setAttribute("data-sender",n),n===window.username&&m.classList.add("own-message"),window.loadAvatar(n).then((e=>{const t=m.querySelector(".message-avatar");t&&(t.src=e)})),m.innerHTML=u,t.appendChild(m),s&&m.scrollIntoView({behavior:"smooth"}),o[t.dataset.channelId]={sender:n,timestamp:new Date(e.timestamp)}}function f(e){const t=Array.from(e.querySelectorAll(".text-message"));t.forEach(((e,n)=>{const a=t[n-1],o=t[n+1],s=e.dataset.sender,l=a?a.dataset.sender:null,c=o?o.dataset.sender:null,u=a?a.dataset.timestamp:null,m=o?o.dataset.timestamp:null,p=e.dataset.timestamp,w=a&&l===s&&!r(u,p),g=o&&c===s&&!r(p,m);let y="only-message";!w&&g?y="first-message":w&&!g?y="last-message":w&&g&&(y="middle-message");const h=e.classList.contains("first-message")?"first-message":e.classList.contains("last-message")?"last-message":e.classList.contains("middle-message")?"middle-message":"only-message";e.classList.remove("first-message","middle-message","last-message","only-message"),e.classList.add(y);const f=e.querySelector(".message-item");if(f&&y!==h)if("first-message"!==y&&"only-message"!==y||"first-message"===h||"only-message"===h){if(!("middle-message"!==y&&"last-message"!==y||"first-message"!==h&&"only-message"!==h)){const e=f.querySelector(".message-header");if(e&&e.remove(),!f.querySelector(".hover-time")){const e=document.createElement("span");e.className="hover-time",e.textContent=d(p),f.insertBefore(e,f.firstChild)}}}else{const t=f.querySelector(".hover-time");if(t&&t.remove(),!f.querySelector(".message-header")){const t=e.dataset.sender,n=document.createElement("div");n.className="message-header",n.innerHTML=`\n            <div class="message-avatar-container">\n              <img class="message-avatar" data-username="${t}" src="/images/default-avatar.png" alt="">\n            </div>\n            <div class="sender-info">\n              <span class="sender-name">${t}</span>\n              <span class="timestamp">${i(p)}</span>\n            </div>`;const a=f.querySelector(".delete-icon");a?f.insertBefore(n,a.nextSibling):f.insertBefore(n,f.firstChild),window.loadAvatar(t).then((e=>{const t=n.querySelector(".message-avatar");t&&(t.src=e)}))}}const v=e.querySelector(".message-content");v&&(v.classList.remove("first-message","middle-message","last-message","only-message"),v.classList.add(y))}))}function v(e,t){const n=e.querySelector(`.text-message[data-id="${t}"]`);if(!n)return;const a=n.previousElementSibling,o=n.nextElementSibling;n.remove(),a&&a.classList.contains("date-separator")&&(!o||o.classList.contains("date-separator"))&&a.remove(),f(e)}function E(e,t){const n=function(){let n,a=0;return(...o)=>{const r=100-(Date.now()-a),i=()=>{a=Date.now(),requestAnimationFrame((()=>function(){const n=t.scrollTop+t.clientHeight>=t.scrollHeight-5,a=window.selectedGroup,o=t.dataset.channelId;n&&a&&o&&window.channelUnreadCounts[a]&&window.channelUnreadCounts[a][o]>0&&e.emit("markChannelRead",{groupId:a,channelId:o})}(...o)))};r<=0?i():(clearTimeout(n),n=setTimeout(i,r))}}();t.addEventListener("scroll",n),e.on("textHistory",(e=>{y(e,t),n()})),e.on("newTextMessage",(e=>{if(e.channelId===t.dataset.channelId){const a=e.message;let o=t.lastElementChild,i=null;if(o&&o.classList.contains("date-separator"))i=o.getAttribute("data-timestamp");else{let e=t.lastElementChild;for(;e&&e.classList.contains("date-separator");)e=e.previousElementSibling;e&&(i=e.getAttribute("data-timestamp"))}i&&!r(i,a.timestamp)||s(t,a.timestamp),h(a,t),n();const d=Array.isArray(a.attachments)?a.attachments.map((e=>e.url)).filter((e=>e&&e.startsWith("/uploads/"))):[];d.length&&window.cacheUploadUrls&&window.cacheUploadUrls(d)}})),e.on("textMessageDeleted",(({channelId:e,messageId:n})=>{e===t.dataset.channelId&&(v(t,n),f(t))})),e.on("avatarUpdated",(({username:e,avatar:n})=>{window.userAvatars[e]=n,t.querySelectorAll(`[data-username="${e}"]`).forEach((e=>{e.src=n||"/images/default-avatar.png"}))})),t.addEventListener("click",(n=>{const o=n.target.closest(".message-avatar"),r=n.target.closest(".sender-name"),i=n.target.closest(".message-attachments img, .message-attachments video"),d=n.target.closest(".attachment-wrapper"),s=n.target.closest(".delete-icon");if(o){const e=o.dataset.username;e&&(0,a.Ij)(e,n)}else if(r)(0,a.Ij)(r.textContent.trim(),n);else if(i)!function(e){if(!u){u=document.createElement("div"),u.id="mediaLightbox",u.className="modal";const e=document.createElement("div");e.className="modal-content",e.style.background="transparent",e.style.boxShadow="none",e.style.padding="0",u.appendChild(e),u.style.display="none",u.addEventListener("click",(e=>{e.target===u&&p()})),document.body.appendChild(u)}const t=u.querySelector(".modal-content");let n;t.innerHTML="","IMG"===e.tagName?(n=document.createElement("img"),n.src=e.dataset.lightbox||e.src):(n=document.createElement("video"),n.src=e.dataset.lightbox||e.querySelector("source")?.src||e.src,n.controls=!0),t.appendChild(n),u.style.display="flex",u.classList.add("active"),document.addEventListener("keydown",m)}(i);else if(d){n.preventDefault();const e=d.dataset.url,t=d.dataset.name||"";if(n.shiftKey)window.open(e,"_blank");else{const n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.click(),n.remove()}}else if(s){const a=s.closest(".text-message");a&&(n.shiftKey||window.confirm("Bu mesajı silmek istediğinize emin misiniz?"))&&(e.emit("deleteTextMessage",{channelId:t.dataset.channelId,messageId:a.dataset.id}),v(t,a.dataset.id),f(t))}}))}},604:(e,t,n)=>{function a(e){return e?(void 0!==e.value?e.value:e.innerText).replace(/\u00a0/g," "):""}function o(e){e&&(void 0!==e.value?e.value="":e.innerHTML="")}function r(e,t,n){e&&n&&(""!==a(e).trim()?(n.style.display="block",t&&(t.style.display="none")):(n.style.display="none",t&&(t.style.display="block")))}n.d(t,{Q0:()=>o,os:()=>a,rW:()=>r})}},a={};function o(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={exports:{}};return n[e](r,r.exports,o),r.exports}o.m=n,o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce(((t,n)=>(o.f[n](e,t),t)),[])),o.u=e=>e+".bundle.js",o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="test:",o.l=(n,a,r,i)=>{if(e[n])e[n].push(a);else{var d,s;if(void 0!==r)for(var l=document.getElementsByTagName("script"),c=0;c<l.length;c++){var u=l[c];if(u.getAttribute("src")==n||u.getAttribute("data-webpack")==t+r){d=u;break}}d||(s=!0,(d=document.createElement("script")).charset="utf-8",d.timeout=120,o.nc&&d.setAttribute("nonce",o.nc),d.setAttribute("data-webpack",t+r),d.src=n),e[n]=[a];var m=(t,a)=>{d.onerror=d.onload=null,clearTimeout(p);var o=e[n];if(delete e[n],d.parentNode&&d.parentNode.removeChild(d),o&&o.forEach((e=>e(a))),t)return t(a)},p=setTimeout(m.bind(null,void 0,{type:"timeout",target:d}),12e4);d.onerror=m.bind(null,d.onerror),d.onload=m.bind(null,d.onload),s&&document.head.appendChild(d)}},o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var a=n.length-1;a>-1&&(!e||!/^http(s?):/.test(e));)e=n[a--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(()=>{var e={792:0};o.f.j=(t,n)=>{var a=o.o(e,t)?e[t]:void 0;if(0!==a)if(a)n.push(a[2]);else{var r=new Promise(((n,o)=>a=e[t]=[n,o]));n.push(a[2]=r);var i=o.p+o.u(t),d=new Error;o.l(i,(n=>{if(o.o(e,t)&&(0!==(a=e[t])&&(e[t]=void 0),a)){var r=n&&("load"===n.type?"missing":n.type),i=n&&n.target&&n.target.src;d.message="Loading chunk "+t+" failed.\n("+r+": "+i+")",d.name="ChunkLoadError",d.type=r,d.request=i,a[1](d)}}),"chunk-"+t,t)}};var t=(t,n)=>{var a,r,[i,d,s]=n,l=0;if(i.some((t=>0!==e[t]))){for(a in d)o.o(d,a)&&(o.m[a]=d[a]);s&&s(o)}for(t&&t(n);l<i.length;l++)r=i[l],o.o(e,r)&&e[r]&&e[r][0](),e[r]=0},n=self.webpackChunktest=self.webpackChunktest||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var r={};o.r(r),o.d(r,{audioPermissionGranted:()=>L,consumeProducer:()=>q,consumers:()=>k,createTransport:()=>D,createTransportFlow:()=>N,device:()=>f,deviceIsLoaded:()=>v,joinRoom:()=>P,leaveRoomInternal:()=>R,listProducers:()=>G,localProducer:()=>S,localStream:()=>I,recvTransport:()=>C,remoteAudios:()=>b,requestMicrophoneAccess:()=>A,screenShareContainer:()=>B,screenShareVideo:()=>x,sendTransport:()=>E,setScreenShareContainer:()=>T,setScreenShareVideo:()=>M,showScreenShare:()=>$,startSfuFlow:()=>U});var i=o(17);const d={info:(...e)=>console.info(...e),warn:(...e)=>console.warn(...e),error:(...e)=>console.error(...e)};async function s(e,t,n={video:!0,audio:!0}){try{const a=await navigator.mediaDevices.getDisplayMedia({video:n.video,audio:n.audio});window.screenShareStream=a;const o=a.getVideoTracks()[0],r=await e.produce({track:o,stopTracks:!1});window.screenShareProducerVideo=r;let i=null;if(a.getAudioTracks().length>0){const t=a.getAudioTracks()[0];i=await e.produce({track:t,stopTracks:!1}),window.screenShareProducerAudio=i}return t.emit("screenShareStatusChanged",{isScreenSharing:!0}),t.emit("screenShareStarted",{producerId:r.id}),o.onended=()=>{l(t)},{videoProducer:r,audioProducer:i}}catch(e){throw console.error("Screen sharing failed:",e),e}}async function l(e){window.screenShareProducerVideo&&(await window.screenShareProducerVideo.close(),window.screenShareProducerVideo=null),window.screenShareProducerAudio&&(await window.screenShareProducerAudio.close(),window.screenShareProducerAudio=null),window.screenShareStream&&(window.screenShareStream.getTracks().forEach((e=>{e.stop(),e.enabled=!1})),window.screenShareStream=null),e.emit("screenShareStatusChanged",{isScreenSharing:!1}),e.emit("screenShareEnded"),d.info("Ekran paylaşımı tamamen durduruldu."),"undefined"!=typeof window&&window.clearScreenShareUI&&window.clearScreenShareUI()}let c=null;function u(e){const t=document.getElementById("cellBar1"),n=document.getElementById("cellBar2"),a=document.getElementById("cellBar3"),o=document.getElementById("cellBar4");let r=0;r=e>=1?e<80?4:e<150?3:e<300?2:1:0,[t,n,a,o].forEach((e=>e&&e.classList.remove("active"))),r>=1&&t&&t.classList.add("active"),r>=2&&n&&n.classList.add("active"),r>=3&&a&&a.classList.add("active"),r>=4&&o&&o.classList.add("active")}function m(e){const t=document.getElementById("pingValue"),n=document.getElementById("panelChannelName"),a=document.getElementById("panelGroupName");let o="#2dbf2d";e>=150?o="#ff0000":e>=80&&(o="#ffcc00"),t&&(t.style.color=o);const r=window.activeVoiceChannelName||"",i=document.getElementById("groupTitle"),d=window.activeVoiceGroupName||(i?i.textContent:"");a&&(a.textContent=d),n&&(n.textContent=r)}const p=.02,w=100;let g={};async function y(e,t){if(!e.getAudioTracks().length)return void console.warn("No audio tracks in MediaStream for user:",t);h(t);const n=new AudioContext,a=n.createMediaStreamSource(e),o=n.createAnalyser();o.fftSize=512,a.connect(o);const r=new Uint8Array(o.fftSize),i=setInterval((()=>{o.getByteTimeDomainData(r);let e=0;for(let t=0;t<r.length;t++){const n=(r[t]-128)/128;e+=Math.abs(n)}const n=e/r.length,a=document.getElementById(`avatar-${t}`);a&&(n>p?a.classList.add("speaking"):a.classList.remove("speaking"))}),w);g[t]={audioContext:n,analyser:o,dataArray:r,interval:i}}function h(e){g[e]&&(clearInterval(g[e].interval),g[e].audioContext.close().catch((()=>{})),delete g[e])}let f=null,v=!1,E=null,C=null,I=null,L=!1,S=null,k={},b=[],x=null,B=null;function M(e){x=e}function T(e){B=e}async function A(e,t,n){try{d.info("Mikrofon izni isteniyor...");const a={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!1}},o=await navigator.mediaDevices.getUserMedia(a);return d.info("Mikrofon erişimi verildi: "+o),I=o,L=!0,n&&(n.value=!0),t(),y(I,e.id),b.forEach((e=>{e.play().catch((e=>console.error("Ses oynatılamadı:",e)))})),o}catch(e){return console.error("Mikrofon izni alınamadı:",e),L=!1,n&&(n.value=!1),t(),null}}function U(e,t,n){d.info("startSfuFlow => group: "+t+" room: "+n),f||(f=new mediasoupClient.Device),I&&"ended"!==I.getAudioTracks()[0].readyState?N(e,t,n):A(e,(()=>{}),null).then((()=>{d.info("Mikrofon izni alındı, SFU akışı başlatılıyor..."),N(e,t,n)})).catch((e=>{console.error("Mikrofon izni alınamadı:",e)}))}async function N(e,t,n){const a=await D(e,t,n);if(a.error)return void console.error("createTransport error:",a.error);if(v?d.info("Device zaten yüklü."):(await f.load({routerRtpCapabilities:a.routerRtpCapabilities}),v=!0,d.info("Device yüklendi: "+f.rtpCapabilities)),E=f.createSendTransport(a),E.on("connect",(({dtlsParameters:o},r,i)=>{d.info("sendTransport connect => dtls"),e.emit("connectTransport",{groupId:t,roomId:n,transportId:a.id,dtlsParameters:o},(e=>{e&&e.error?i(e.error):r()}))})),E.on("produce",(async(o,r,i)=>{d.info("sendTransport produce => "+JSON.stringify(o)),e.emit("produce",{groupId:t,roomId:n,transportId:a.id,kind:o.kind,rtpParameters:o.rtpParameters},(e=>{e.error?i(e.error):r({id:e.producerId})}))})),I&&I.getAudioTracks().length>0){let t=I.getAudioTracks()[0];try{S=await E.produce({track:t,stopTracks:!1}),d.info("Mikrofon producer oluşturuldu: "+S.id)}catch(n){if("InvalidStateError"!==n.name)throw n;console.error("Audio track bitti, yeniden mikrofon izni isteniyor..."),await A(e,(()=>{}),null),t=I.getAudioTracks()[0],S=await E.produce({track:t,stopTracks:!1}),d.info("Yeni audio track ile producer oluşturuldu: "+S.id)}}else console.warn("Yerel ses akışı bulunamadı, producer oluşturulmayacak."),S=null;const o=await D(e,t,n);if(o.error)return void console.error("createTransport (recv) error:",o.error);C=f.createRecvTransport(o),C.on("connect",(({dtlsParameters:a},r,i)=>{d.info("recvTransport connect => dtls"),e.emit("connectTransport",{groupId:t,roomId:n,transportId:o.id,dtlsParameters:a},(e=>{e&&e.error?i(e.error):r()}))}));const r=await G(e,t,n);d.info("Mevcut producerlar: "+JSON.stringify(r));for(const a of r)a.peerId!==e.id?await q(e,t,n,a.id):d.info("Kendi producer, tüketme yapılmıyor: "+a.id);d.info("SFU akışı tamamlandı."),"function"==typeof window.setConnectionStatus&&window.setConnectionStatus("connected")}function D(e,t,n){return new Promise((a=>{e.emit("createWebRtcTransport",{groupId:t,roomId:n},(e=>{a(e)}))}))}function G(e,t,n){return new Promise((a=>{e.emit("listProducers",{groupId:t,roomId:n},(e=>{a(e||[])}))}))}async function q(e,t,n,a){if(!C)return void console.warn("consumeProducer: recvTransport yok");const o=await new Promise((o=>{e.emit("consume",{groupId:t,roomId:n,transportId:C.id,producerId:a},(e=>{o(e)}))}));if(o.error)return void console.error("consume error:",o.error);d.info("consumeProducer parametreleri: "+JSON.stringify(o));const r=await C.consume({id:o.id,producerId:o.producerId,kind:o.kind,rtpParameters:o.rtpParameters});if(r.appData={peerId:o.producerPeerId},k[r.id]=r,"audio"===r.kind){const{track:e}=r,t=document.createElement("audio");t.srcObject=new MediaStream([e]),t.autoplay=!0,t.dataset.peerId=r.appData.peerId,b.push(t),t.play().catch((e=>console.error("Ses oynatılamadı:",e))),y(t.srcObject,r.appData.peerId),d.info("Yeni audio consumer oluşturuldu: "+r.id+" -> konuşan: "+r.appData.peerId),"function"==typeof window.setConnectionStatus&&window.setConnectionStatus("connected")}else"video"===r.kind&&d.info("Video consumer alındı, ekran paylaşım için tıklama ile consume edilecek. Producer: "+o.producerId)}function R(e){x&&x.dataset.peerId&&e.emit("stopWatching",{userId:x.dataset.peerId}),(window.screenShareProducerVideo||window.screenShareStream)&&l(e),S&&(S.close(),S=null),E&&(E.close(),E=null),C&&(C.close(),C=null);for(const e in k)h(k[e].appData.peerId);k={},b.forEach((e=>{try{e.pause()}catch(e){}e.srcObject=null})),b=[],"undefined"!=typeof window&&(window.currentRoom=null,window.currentRoomType=null,void 0!==window.activeVoiceChannelName&&(window.activeVoiceChannelName=""),void 0!==window.activeVoiceGroupName&&(window.activeVoiceGroupName="")),d.info("leaveRoomInternal: SFU transportlar kapatıldı")}function P(e,t,n,a,o,r,i,d){e.emit("joinRoom",{groupId:t,roomId:n}),r&&(r.textContent=a),window.activeVoiceChannelName=a,"string"==typeof o&&(window.activeVoiceGroupName=o),m(0),i&&i(),d&&(d.value="voice")}async function $(e,t,n,a,o){if(!C)return void console.warn("recvTransport yok");o();const r=await new Promise((o=>{e.emit("consume",{groupId:t,roomId:n,transportId:C.id,producerId:a},(e=>{o(e)}))}));if(r.error)return void console.error("consume error:",r.error);const i=await C.consume({id:r.id,producerId:r.producerId,kind:r.kind,rtpParameters:r.rtpParameters});if(i.appData={peerId:r.producerPeerId},k[i.id]=i,"audio"===i.kind){const{track:e}=i,t=document.createElement("audio");t.srcObject=new MediaStream([e]),t.autoplay=!0,t.dataset.peerId=i.appData.peerId,b.push(t),t.play().catch((e=>console.error("Ses oynatılamadı:",e))),y(t.srcObject,i.appData.peerId)}else if("video"===i.kind){x=document.createElement("video"),x.srcObject=new MediaStream([i.track]),x.autoplay=!0,x.dataset.peerId=i.appData.peerId,window.broadcastingUserId=i.appData.peerId;const t=()=>{i.close(),delete k[i.id];for(const e in k){const t=k[e];if("audio"===t.kind&&t.appData.peerId===i.appData.peerId){t.close(),h(t.appData.peerId),delete k[e];const n=b.findIndex((e=>e.dataset.peerId===t.appData.peerId));if(-1!==n){const e=b[n];try{e.pause()}catch(e){}e.srcObject=null,b.splice(n,1)}}}B&&B.parentNode&&B.parentNode.removeChild(B),e.emit("stopWatching",{userId:i.appData.peerId}),x=null,B=null,window.broadcastingUserId=null,window.latestChannelsData&&window.currentRoom&&"function"==typeof window.renderVoiceChannelGrid&&window.latestChannelsData[window.currentRoom]&&window.renderVoiceChannelGrid(window.latestChannelsData[window.currentRoom].users),"function"==typeof window.clearScreenShareUI&&window.clearScreenShareUI()};B=function(e,t){const n=document.createElement("div");n.classList.add("screen-share-container"),n.appendChild(e);const a=document.createElement("span");if(a.classList.add("material-icons","fullscreen-icon"),a.textContent="fullscreen",a.addEventListener("click",(()=>{n.requestFullscreen&&n.requestFullscreen()})),n.appendChild(a),"function"==typeof t){const e=document.createElement("span");e.classList.add("material-icons","screen-share-end-icon"),e.textContent="call_end",e.style.display="none",n.appendChild(e),n.addEventListener("mouseenter",(()=>{e.style.display="block"})),n.addEventListener("mouseleave",(()=>{e.style.display="none"})),e.addEventListener("click",t)}return n}(x,t),function(){const e=document.getElementById("screenShareEndedMessage");e&&e.parentNode&&e.parentNode.removeChild(e)}(),e.emit("startWatching",{userId:i.appData.peerId});const n=document.getElementById("channelUsersContainer");if(n){const e=n.querySelector(`.user-card[data-user-id="${i.appData.peerId}"]`);e&&(n.classList.add("broadcast-mode"),n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="space-between",n.style.gridTemplateColumns="",n.style.gridAutoRows="",e.classList.add("broadcast-card"),e.appendChild(B))}window.latestChannelsData&&window.currentRoom&&window.renderVoiceChannelGrid(window.latestChannelsData[window.currentRoom].users),d.info("Yeni video consumer oluşturuldu: "+i.id+" -> yayıncı: "+i.appData.peerId),"function"==typeof window.setConnectionStatus&&window.setConnectionStatus("connected")}}var z=o(604);let H=[],j=null,O=0,_=null,V=null;function F(){return H.slice()}function W(){H=[];const e=document.getElementById("attachmentPreview");e&&(e.innerHTML=""),e&&(e.style.display="none"),_&&(_.style.display="none",V&&(V.value=""));const t=document.getElementById("textMessages");t&&(t.style.display=""),j&&(document.removeEventListener("click",j),j=null)}function Y(e,t){const n=document.querySelector(`#attachmentPreview .preview-item[data-index="${e}"]`);if(n){n.classList.add("upload-failed");const e=n.querySelector(".retry-btn");e&&(e.style.display="block",t&&(e.onclick=t))}}let K=[],J=null,X=-1,Q=null;function Z(){J&&(J.style.display="none",J.innerHTML="",X=-1)}function ee(){J&&J.querySelectorAll(".mention-dropdown-item").forEach(((e,t)=>{t===X?e.classList.add("active"):e.classList.remove("active")}))}function te(e){if(!Q)return;const t=window.getSelection();if(!t||!t.rangeCount)return;const n=t.getRangeAt(0);n.deleteContents();const a=document.createElement("span");a.className="mention",a.textContent=`@${e}`,n.insertNode(a);const o=document.createTextNode(" ");a.after(o),n.setStartAfter(o),n.collapse(!0),t.removeAllRanges(),t.addRange(n),Z()}function ne(e,t,n){const{loginButton:a,loginForm:o,loginUsernameInput:r,loginPasswordInput:i,registerButton:d,regPasswordConfirmInput:c,loginScreen:u,registerScreen:p,showRegisterScreen:w,showLoginScreen:g,backToLoginButton:y,groupDropdownIcon:h,groupDropdownMenu:f,copyGroupIdBtn:v,createGroupButton:C,createChannelBtn:I,groupSettingsBtn:L,leaveGroupBtn:S,toggleDMButton:k,roomPanel:b,rightPanel:x,leaveButton:B,micToggleButton:M,deafenToggleButton:T,settingsButton:A,sendTextMessageBtn:U,micMessageBtn:N,textChannelMessageInput:D,screenShareButton:G,screenShareLargeButton:q,toggleUserListButton:R,channelContentArea:P,selectedChannelTitle:$,textChannelContainer:H,groupModal:j,modalGroupCreateBtn:O,modalGroupJoinBtn:_,actualGroupCreateModal:V,actualGroupName:ne,actualGroupNameBtn:ae,closeCreateGroupModal:oe,joinGroupModal:re,joinGroupIdInput:ie,joinGroupIdBtn:de,closeJoinGroupModal:se,groupSettingsModal:le,closeGroupSettingsModal:ce,userSettingsPage:ue,closeUserSettingsPageBtn:me,roomModal:pe,modalRoomName:we,textChannel:ge,voiceChannel:ye,modalCreateRoomBtn:he,modalCloseRoomBtn:fe,createCategoryBtn:ve,categoryModal:Ee,modalCategoryName:Ce,modalCreateCategoryBtn:Ie,modalCloseCategoryBtn:Le,createChannelTargetCategory:Se}=window;window.createChannelTargetCategory??=null,function(e){e.on("groupUsers",(e=>{const t=[];e&&e.online&&t.push(...e.online.map((e=>({username:e.username,avatar:e.avatar})))),e&&e.offline&&t.push(...e.offline.map((e=>({username:e.username,avatar:e.avatar})))),K=t}))}(e);const ke="rightPanelOpen";function be(e){e?(x.style.display="flex",x.offsetWidth,requestAnimationFrame((()=>x.classList.remove("collapsed")))):(x.classList.add("collapsed"),x.addEventListener("transitionend",(function e(t){"width"===t.propertyName&&(x.style.display="none",x.removeEventListener("transitionend",e))})))}function xe(){const t=document.getElementById("previewWrapper"),n=t?.querySelector(".caption-input"),a=t&&"none"!==t.style.display?n?.value.trim()||"":(0,z.os)(D).trim(),o=F();if(!a&&0===o.length)return;if(0===o.length)return e.emit("textMessage",{groupId:window.selectedGroup,roomId:window.currentTextChannel,message:a,username:window.username}),(0,z.Q0)(D),n&&(n.value=""),U.style.display="none",void(N&&(N.style.display="block"));const r=new FormData;r.append("username",window.username||""),r.append("channelId",window.currentTextChannel),r.append("content",a),o.forEach((e=>r.append("files",e.file)));const i=o.map((e=>e.file.size)),d=[];i.reduce(((e,t,n)=>(d[n]=e,e+t)),0);const s=new XMLHttpRequest;s.upload.onprogress=e=>{const t=e.loaded;i.forEach(((e,n)=>{const a=d[n];let o=0;t>=a+e?o=100:t>a&&(o=(t-a)/e*100),function(e,t){const n=document.querySelector(`#attachmentPreview .preview-item[data-index="${e}"] .bar`);n&&(n.style.width=`${t}%`)}(n,o)}))},s.onload=()=>{if(s.status>=200&&s.status<300){let e={};try{e=JSON.parse(s.responseText)}catch{}W(),(0,z.Q0)(D),n&&(n.value=""),t&&(t.style.display="none"),U.style.display="none",N&&(N.style.display="block")}else o.forEach(((e,t)=>Y(t,xe)))},s.onerror=()=>{o.forEach(((e,t)=>Y(t,xe)))},s.open("POST","/api/message"),s.send(r)}(()=>{try{return"0"!==localStorage.getItem(ke)}catch(e){return!0}})()?x.style.display="flex":(x.classList.add("collapsed"),x.style.display="none"),o.addEventListener("submit",(e=>{e.preventDefault(),t()})),d.addEventListener("click",(()=>n())),c.addEventListener("keydown",(e=>"Enter"===e.key&&n())),w.addEventListener("click",(()=>{u.style.display="none",p.style.display="block"})),g.addEventListener("click",(()=>{p.style.display="none",u.style.display="block"})),y.addEventListener("click",(()=>{p.style.display="none",u.style.display="block"})),h&&h.addEventListener("click",(e=>{e.stopPropagation(),"none"!==f.style.display&&f.style.display?f.style.display="none":f.style.display="flex"})),document.addEventListener("click",(e=>{f&&"none"!==f.style.display&&!f.contains(e.target)&&e.target!==h&&(f.style.display="none")})),v&&v.addEventListener("click",(()=>{const e=window.selectedGroup||window.currentGroup;e&&navigator.clipboard.writeText(e),f&&(f.style.display="none")})),I&&I.addEventListener("click",(()=>{window.createChannelTargetCategory=null,pe&&(pe.style.display="flex",pe.classList.add("active")),f&&(f.style.display="none")})),ve&&ve.addEventListener("click",(()=>{Ee&&(Ee.style.display="flex",Ee.classList.add("active")),f&&(f.style.display="none")})),fe&&fe.addEventListener("click",(()=>{pe&&(pe.style.display="none",pe.classList.remove("active"))})),Le&&Le.addEventListener("click",(()=>{Ee&&(Ee.style.display="none",Ee.classList.remove("active"))})),he&&he.addEventListener("click",(()=>{const t=we?we.value.trim():"";if(!t)return;const n=ye&&ye.checked?"voice":"text";e.emit("createChannel",{groupId:window.selectedGroup,name:t,type:n,categoryId:window.createChannelTargetCategory}),window.createChannelTargetCategory=null,we.value="",pe&&(pe.style.display="none",pe.classList.remove("active"))})),Ie&&Ie.addEventListener("click",(()=>{const t=Ce?Ce.value.trim():"";t&&(e.emit("createCategory",{groupId:window.selectedGroup,name:t}),Ce.value="",Ee&&(Ee.style.display="none",Ee.classList.remove("active")))})),L&&L.addEventListener("click",(()=>{le&&"none"!==L.style.display&&(le.style.display="flex",le.classList.add("active"),document.body.style.overflow="hidden"),f&&(f.style.display="none")})),S&&S.addEventListener("click",(()=>{window.selectedGroup&&e.emit("leaveGroup",window.selectedGroup),f&&(f.style.display="none")})),C&&C.addEventListener("click",(()=>{j&&(j.style.display="flex",j.classList.add("active"))})),O&&O.addEventListener("click",(()=>{j&&(j.style.display="none",j.classList.remove("active")),V&&(V.style.display="flex",V.classList.add("active"))})),_&&_.addEventListener("click",(()=>{j&&(j.style.display="none",j.classList.remove("active")),re&&(re.style.display="flex",re.classList.add("active"))})),oe&&oe.addEventListener("click",(()=>{V&&(V.style.display="none",V.classList.remove("active"))})),se&&se.addEventListener("click",(()=>{re&&(re.style.display="none",re.classList.remove("active"))})),ce&&ce.addEventListener("click",(()=>{le&&(le.style.display="none",le.classList.remove("active")),document.body.style.overflow=""})),me&&me.addEventListener("click",(()=>{"function"==typeof window.closeUserSettings&&window.closeUserSettings()})),ae&&ae.addEventListener("click",(()=>{const t=ne?ne.value.trim():"";if(!t)return;const n=prompt("Metin kanalı adı:","general");n&&""!==n.trim()&&(e.emit("createGroup",{groupName:t,channelName:n.trim()}),ne.value="",V&&(V.style.display="none"))})),de&&de.addEventListener("click",(()=>{const t=ie?ie.value.trim():"";t&&(e.emit("joinGroup",t),ie.value="",re&&(re.style.display="none"))})),k.addEventListener("click",(()=>{window.removeScreenShareEndedMessage();const e=document.getElementById("channelContentArea"),t=document.getElementById("selectedChannelBar"),n=document.getElementById("selectedDMBar"),a=document.getElementById("dmContentArea"),o=document.getElementById("dmPanel");if(window.isDMMode){b.style.display="flex",e.style.display="flex",be((()=>{try{return"0"!==localStorage.getItem(ke)}catch(e){return!0}})()),n.style.display="none",a.style.display="none",o.style.display="none",t.style.display="flex",k.querySelector(".material-icons").textContent="forum",$.textContent="Kanal Seçilmedi",window.isDMMode=!1;const r=document.getElementById("textMessages"),i=document.getElementById("textChannelMessageInput"),d=document.getElementById("textChatInputBar");r&&(r.style.width=""),i&&(i.style.width=""),d&&(d.style.width="")}else b.style.display="none",e.style.display="none",be(!1),t.style.display="none",n.style.display="flex",a.style.display="flex",o.style.display="block",k.querySelector(".material-icons").textContent="group",window.isDMMode=!0})),R&&R.addEventListener("click",(()=>{!function(e){be(e);try{localStorage.setItem(ke,e?"1":"0")}catch(e){}}(!!x.classList.contains("collapsed"))})),B&&B.addEventListener("click",(()=>{if(window.clearScreenShareUI(),!window.currentRoom)return;e.emit("leaveRoom",{groupId:window.currentGroup,roomId:window.currentRoom}),window.leaveRoomInternal(e),window.activeVoiceChannelName="",window.activeVoiceGroupName="",m(0),"function"==typeof window.hideVoiceSections&&window.hideVoiceSections();const t=document.getElementById("channelUsersContainer");if(t&&(t.innerHTML=""),document.querySelectorAll(".channel-item").forEach((e=>e.classList.remove("connected"))),e.emit("browseGroup",window.currentGroup),window.currentTextChannel){const e=document.querySelector(`.channel-item[data-room-id="${window.currentTextChannel}"]`);if(e){e.classList.add("connected");const t=e.querySelector(".channel-header .channel-name");t&&($.textContent=t.textContent),H.style.display="flex",H.style.flexDirection="column"}}})),M.addEventListener("click",(()=>{window.micEnabled=!window.micEnabled,window.applyAudioStates()})),T.addEventListener("click",(()=>{window.selfDeafened?(window.selfDeafened=!1,window.micWasEnabledBeforeDeaf&&(window.micEnabled=!0)):(window.micWasEnabledBeforeDeaf=window.micEnabled,window.selfDeafened=!0,window.micEnabled=!1),window.applyAudioStates()})),A.addEventListener("click",(()=>{"function"==typeof window.openUserSettings&&window.openUserSettings()})),U.addEventListener("click",(()=>{Z(),xe()})),D.addEventListener("input",(e=>{(0,z.rW)(D,N,U),function(e){Q=e;const t=function(e){const t=window.getSelection();if(!t||!t.rangeCount)return 0;const n=t.getRangeAt(0).cloneRange();return n.selectNodeContents(e),n.setEnd(t.focusNode,t.focusOffset),n.toString().length}(e),n=void 0!==e.value?e.value:e.innerText,a=n.lastIndexOf("@",t-1);if(-1===a)return void Z();const o=n.slice(a+1,t);if(/\s/.test(o))return void Z();const r=K.filter((e=>e.username.toLowerCase().startsWith(o.toLowerCase())));if(!r.length)return void Z();const i=(J||(J=document.createElement("div"),J.className="mention-dropdown",J.style.display="none",document.body.appendChild(J)),J);i.innerHTML="",r.forEach(((e,t)=>{const n=document.createElement("div");n.className="mention-dropdown-item",n.dataset.username=e.username;const a=document.createElement("img");a.src=e.avatar||"/images/default-avatar.png",a.width=24,a.height=24,a.style.borderRadius="45%";const o=document.createElement("span");o.textContent=e.username,n.appendChild(a),n.appendChild(o),n.addEventListener("mousedown",(t=>{t.preventDefault(),te(e.username)})),i.appendChild(n)})),X=0,ee();const d=e.getBoundingClientRect();i.style.width=d.width+"px";const s=document.getElementById("selectedChannelBar"),l=s?s.getBoundingClientRect().bottom:0,c=parseFloat(getComputedStyle(document.documentElement).fontSize),u=d.top-l-c;i.style.maxHeight=u+"px",i.style.left=d.left+"px",i.style.display="block";const m=Math.min(i.scrollHeight,u);i.style.top=d.top-m-c+"px"}(e.target)})),D.addEventListener("keydown",(e=>{(function(e){if(!J||"none"===J.style.display)return!1;if("ArrowDown"===e.key){e.preventDefault();const t=J.children.length;return X=Math.min(X+1,t-1),ee(),!0}if("ArrowUp"===e.key)return e.preventDefault(),X=Math.max(X-1,0),ee(),!0;if("Enter"===e.key){e.preventDefault();const t=J.children[X];return t&&te(t.dataset.username),!0}return"Escape"===e.key&&(Z(),!0)})(e)||"Enter"===e.key&&(e.preventDefault(),xe())}));const Be=document.querySelector("#previewWrapper .caption-input");Be&&(Be.addEventListener("input",(()=>{""!==Be.value.trim()||F().length>0?(U.style.display="block",N&&(N.style.display="none")):(U.style.display="none",N&&(N.style.display="block"))})),Be.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),xe())}))),G&&G.addEventListener("click",(async()=>{if(window.screenShareProducerVideo){await l(e),G.classList.remove("active");const t=G.querySelector(".material-icons");if(t&&(t.textContent="desktop_windows"),q&&q.classList.remove("active"),q){const e=q.querySelector(".material-icons, .material-icons-outlined");e&&(e.textContent="desktop_windows",e.classList.add("material-icons"),e.classList.remove("material-icons-outlined"))}}else try{if(!E)return void alert("Ekran paylaşımı için transport henüz hazır değil.");window.clearScreenShareUI(),await s(E,e),G.classList.add("active");const t=G.querySelector(".material-icons");if(t&&(t.textContent="desktop_access_disabled"),q&&q.classList.add("active"),q){const e=q.querySelector(".material-icons, .material-icons-outlined");e&&(e.textContent="desktop_access_disabled",e.classList.remove("material-icons"),e.classList.add("material-icons-outlined"))}}catch(e){console.error("Ekran paylaşımı başlatılırken hata:",e)}})),q&&q.addEventListener("click",(async()=>{if(window.screenShareProducerVideo){await l(e),q.classList.remove("active");const t=q.querySelector(".material-icons, .material-icons-outlined");if(t&&(t.textContent="desktop_windows",t.classList.add("material-icons"),t.classList.remove("material-icons-outlined")),G&&G.classList.remove("active"),G){const e=G.querySelector(".material-icons");e&&(e.textContent="desktop_windows")}}else try{if(!E)return void alert("Ekran paylaşımı için transport henüz hazır değil.");window.clearScreenShareUI(),await s(E,e),q.classList.add("active");const t=q.querySelector(".material-icons, .material-icons-outlined");if(t&&(t.textContent="desktop_access_disabled",t.classList.remove("material-icons"),t.classList.add("material-icons-outlined")),G&&G.classList.add("active"),G){const e=G.querySelector(".material-icons");e&&(e.textContent="desktop_access_disabled")}}catch(e){console.error("Ekran paylaşımı başlatılırken hata:",e)}})),P&&P.addEventListener("contextmenu",window.showVideoContextMenu)}var ae=o(427);function oe(e,t){const n=document.createElement("div");n.classList.add("user-item");const a=document.createElement("img");a.classList.add("user-profile-pic"),a.dataset.username=e,a.src="/images/default-avatar.png",window.loadAvatar(e).then((e=>{a.src=e})),a.alt="";const o=document.createElement("span");function r(t){t.stopPropagation(),(0,ae.Ij)(e,t)}return o.classList.add("user-name"),o.textContent=e,n.appendChild(a),n.appendChild(o),a.addEventListener("click",r),o.addEventListener("click",r),n}function re(e){e.on("avatarUpdated",(({username:e,avatar:t})=>{window.userAvatars[e]=t,document.querySelectorAll(`[data-username="${e}"]`).forEach((e=>{e.src=t||"/images/default-avatar.png"}))}))}window.latestChannelsData=null,window.unreadCounter={},window.channelUnreadCounts={},window.groupMuteUntil={},window.channelMuteUntil={},window.categoryMuteUntil={},window.mentionUnread={},window.channelUserRows={};const ie="collapsedCategories";let de={};try{de=JSON.parse(localStorage.getItem(ie))||{}}catch(e){de={}}let se={};function le(){try{localStorage.setItem(ie,JSON.stringify(de))}catch(e){}}function ce(e){e&&e.dispatchEvent(new MouseEvent("click",{bubbles:!0}))}let ue=null;function me(){ue&&(ue.remove(),ue=null)}let pe=null,we=null,ge=null,ye=null,he=null;function fe(e,t){pe&&(pe.style.left=`${e+10}px`,pe.style.top=`${t+10}px`)}function ve(){pe&&(pe.remove(),pe=null)}function Ee(e,t,n){e.setAttribute("draggable","true"),e.addEventListener("dragstart",(e=>{e.stopPropagation(),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t),function(e){ue=document.createElement("div"),ue.classList.add("drag-preview");const t=document.createElement("div");t.classList.add("drag-preview-avatar"),t.dataset.username=e,t.style.backgroundImage="url(/images/default-avatar.png)",window.loadAvatar(e).then((e=>{t.style.backgroundImage=`url(${e})`}));const n=document.createElement("span");n.textContent=e,ue.appendChild(t),ue.appendChild(n),document.body.appendChild(ue)}(n)})),e.addEventListener("dragend",(e=>{e.stopPropagation(),me()}))}function Ce(e,t,n=t){t.addEventListener("dragover",(e=>{if(!ge)return;e.preventDefault();const t=e.target.closest(".channel-item");if(!t||t===ge){const t=e.target.closest(".category-row");if(t){const n=t.getBoundingClientRect(),a=e.clientY-n.top>n.height/2;t.parentNode.insertBefore(we,a?t.nextSibling:t)}else{const t=e.currentTarget;we.parentNode!==t&&t.appendChild(we)}return void fe(e.clientX,e.clientY)}const n=t.getBoundingClientRect(),a=e.clientY-n.top>n.height/2;t.parentNode.insertBefore(we,a?t.nextSibling:t),fe(e.clientX,e.clientY)})),t.addEventListener("drop",(t=>{if(!ge||!we)return;t.preventDefault(),we.parentNode.insertBefore(ge,we);const a=Array.from(n.querySelectorAll(".category-row, .channel-item")).indexOf(ge);ve(),we.remove(),we=null,ge.classList.remove("dragging");const o=ge.parentNode.closest(".category-row"),r=o?o.dataset.categoryId:null;e.emit("assignChannelCategory",{groupId:window.selectedGroup,channelId:ge.dataset.roomId,categoryId:r}),e.emit("reorderChannel",{groupId:window.selectedGroup,channelId:ge.dataset.roomId,newIndex:a}),ge.classList.add("snap");const i=ge;setTimeout((()=>i.classList.remove("snap")),150),ge=null}))}function Ie(e){const{loginScreen:t,callScreen:n,loginErrorMessage:a,loginUsernameInput:o,loginPasswordInput:r,registerScreen:i,registerErrorMessage:s,groupListDiv:l,groupTitle:c,deleteGroupBtn:u,renameGroupBtn:m,groupSettingsBtn:p,leaveGroupBtn:w,roomListDiv:g,selectedChannelTitle:y,textChannelContainer:h}=window;function f(t){function n(t,n){const a=t.querySelector(".channel-user-left"),o=t.querySelector(".channel-user-right");a.dataset.userId=n.id,a.dataset.username=n.username;let r=a.querySelector(".channel-user-avatar");r||(r=document.createElement("div"),r.classList.add("channel-user-avatar"),a.prepend(r)),r.id=`avatar-${n.id}`,r.dataset.username=n.username,r.style.backgroundImage="url(/images/default-avatar.png)",window.loadAvatar(n.username).then((e=>{r.style.backgroundImage=`url(${e})`}));let i=a.querySelector("span.user-name");i||(i=document.createElement("span"),i.classList.add("user-name"),a.appendChild(i)),i.textContent=n.username||"(İsimsiz)";const d=a.querySelector(".visibility-icon");if(e.id&&Array.isArray(window.screenShareWatchers)&&window.screenShareWatchers.includes(n.username)){if(!d){const e=document.createElement("span");e.classList.add("material-icons","visibility-icon"),e.textContent="visibility",a.appendChild(e)}}else d&&d.remove();if(o.innerHTML="",!1===n.hasMic){const e=document.createElement("span");e.classList.add("material-icons","mic-missing"),e.textContent="mic_off",o.appendChild(e)}else if(!1===n.micEnabled){const e=document.createElement("span");e.classList.add("material-icons"),e.textContent="mic_off",o.appendChild(e)}if(!0===n.selfDeafened){const e=document.createElement("span");e.classList.add("material-icons"),e.textContent="headset_off",o.appendChild(e)}if(!0===n.isScreenSharing){const t=document.createElement("span");t.classList.add("screen-share-indicator"),t.textContent="YAYINDA",n.screenShareProducerId&&(t.style.cursor="pointer",t.addEventListener("click",(()=>{window.clearScreenShareUI(),$(e,window.currentGroup,window.currentRoom,n.screenShareProducerId,window.clearScreenShareUI)}))),o.appendChild(t)}}t&&(window.channelUserRows=window.channelUserRows||{},Object.keys(t).forEach((e=>{const a=t[e],o=document.getElementById(`channel-users-${e}`);if(!o)return;const r=window.channelUserRows[e]||{};window.channelUserRows[e]=r;const i=new Set;a.users.forEach((e=>{let t=r[e.id];t?n(t,e):(t=function(e){const t=document.createElement("div");t.classList.add("channel-user");const a=document.createElement("div");a.classList.add("channel-user-left"),t.appendChild(a);const o=document.createElement("div");return o.classList.add("channel-user-right"),t.appendChild(o),Ee(a,e.id,e.username),n(t,e),t}(e),r[e.id]=t),i.add(String(e.id)),o.appendChild(t)})),Object.keys(r).forEach((e=>{if(!i.has(String(e))){const t=r[e];t&&t.parentNode&&t.parentNode.removeChild(t),delete r[e]}}))})))}function v(t,n=!1){const a=document.createElement("div");a.classList.add("user-card"),a.dataset.userId=t.id,a.dataset.username=t.username,n&&a.classList.add("broadcast-card");const o=document.createElement("div");o.classList.add("user-card-info"),a.appendChild(o),!0===t.isScreenSharing&&a.classList.add("stream-available");const r=document.createElement("img");r.classList.add("user-avatar"),r.dataset.username=t.username,r.src="/images/default-avatar.png",r.alt="",window.loadAvatar(t.username).then((e=>{r.src=e}));const i=document.createElement("span");if(i.classList.add("user-name"),i.textContent=t.username||"(İsimsiz)",o.appendChild(r),o.appendChild(i),!1===t.hasMic){const e=document.createElement("span");e.classList.add("material-icons","mic-missing"),e.textContent="mic_off",o.appendChild(e)}else if(!1===t.micEnabled){const e=document.createElement("span");e.classList.add("material-icons"),e.textContent="mic_off",o.appendChild(e)}if(!0===t.selfDeafened){const e=document.createElement("span");e.classList.add("material-icons"),e.textContent="headset_off",o.appendChild(e)}if(!0===t.isScreenSharing){const n=document.createElement("span");if(n.classList.add("screen-share-indicator"),n.textContent="YAYINDA",a.appendChild(n),t.screenShareProducerId&&(!window.screenShareVideo||window.broadcastingUserId!==t.id)){const n=document.createElement("button");n.classList.add("watch-stream-btn","btn","primary"),n.textContent="Watch Stream",n.addEventListener("click",(()=>{window.clearScreenShareUI(),$(e,window.currentGroup,window.currentRoom,t.screenShareProducerId,window.clearScreenShareUI)})),a.appendChild(n)}}return Ee(a,t.id,t.username),a}function E(e){const t=document.getElementById("channelUsersContainer");if(!t)return;if(t.innerHTML="",!Array.isArray(e))return;if(window.screenShareVideo&&window.broadcastingUserId)return void function(e,t){const n=document.getElementById("channelUsersContainer");if(!n)return;n.innerHTML="",n.classList.add("broadcast-mode"),n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="space-between",n.style.gridTemplateColumns="",n.style.gridAutoRows="";const a=e.find((e=>e.id===t)),o=e.filter((e=>e.id!==t));if(a){const e=v(a,!0);n.appendChild(e),window.screenShareContainer&&window.broadcastingUserId===t&&e.appendChild(window.screenShareContainer)}const r=document.createElement("div");r.classList.add("viewer-row"),o.forEach((e=>{r.appendChild(v(e))})),n.appendChild(r)}(e,window.broadcastingUserId);t.classList.remove("broadcast-mode");const n=e.length||0;if(0===n)return;const a=window.getComputedStyle(t),o=parseFloat(a.gap)||0,r=(parseFloat(a.paddingLeft)||0)+(parseFloat(a.paddingRight)||0),i=(parseFloat(a.paddingTop)||0)+(parseFloat(a.paddingBottom)||0),d=t.clientWidth-r,s=t.clientHeight-i;function l(e,t){if(3===e)return{rows:[2,1],columns:2};let n=Math.min(4,Math.max(1,t)),a=Math.ceil(e/n);e%n==1&&a>1&&n<4&&(n+=1,a=Math.ceil(e/n));const o=Math.floor(e/a);let r=e-o*a;const i=new Array(a).fill(o);for(let e=0;e<r;e++)i[e]+=1;return{rows:i,columns:Math.max(...i)}}let c=Math.ceil(Math.sqrt(n)),u=l(n,c),m=(d-o*(u.columns-1))/u.columns,p=9*m/16;for(;p*u.rows.length+o*(u.rows.length-1)>s&&c<n;)c+=1,u=l(n,c),m=(d-o*(u.columns-1))/u.columns,p=9*m/16;const{rows:w,columns:g}=u;t.style.gridTemplateColumns=`repeat(${g}, ${m}px)`,t.style.gridAutoRows=`${p}px`,t.style.justifyContent="center";let y=0;w.forEach(((a,o)=>{const r=Math.floor((g-a)/2);for(let i=0;i<a;i++){const d=v(e[y++]);d.style.gridRow=o+1,1===a?n>1?(d.style.gridColumn=`1 / span ${g}`,d.style.width=`${m}px`,d.style.justifySelf="center"):d.style.gridColumn="1":d.style.gridColumn=r+i+1,t.appendChild(d)}}))}document.addEventListener("dragover",(e=>{var t,n;t=e.clientX,n=e.clientY,ue&&(ue.style.left=`${t+10}px`,ue.style.top=`${n+10}px`),fe(e.clientX,e.clientY)})),g?(Ce(e,g),g.addEventListener("dragover",(e=>{if(!he)return;e.preventDefault();const t=g.getBoundingClientRect();if(e.clientY>=t.bottom-5)return void g.appendChild(ye);const n=e.target.closest(".category-row, .channel-item");if(n){if(n===he)return;const t=n.getBoundingClientRect(),a=e.clientY>t.top+t.height/2;n.parentNode.insertBefore(ye,a?n.nextSibling:n)}else{const n=e.clientY-t.top>t.height/2;g.insertBefore(ye,n?null:g.firstElementChild)}})),g.addEventListener("drop",(t=>{if(!he||!ye)return;t.preventDefault(),ye.parentNode.insertBefore(he,ye);const n=Array.from(g.querySelectorAll(".category-row, .channel-item")).indexOf(he);ye.remove(),ye=null,he.classList.remove("dragging"),e.emit("reorderCategory",{groupId:window.selectedGroup,categoryId:he.dataset.categoryId,newIndex:n}),he.classList.add("snap");const a=he;setTimeout((()=>a.classList.remove("snap")),150),he=null}))):d.warn("roomListDiv element not found, skipping drag and drop setup"),re&&re(e),setInterval((()=>{Object.entries(window.groupMuteUntil||{}).forEach((([t,n])=>{if(n!==1/0&&n&&Date.now()>n){delete window.groupMuteUntil[t],e.emit("muteGroup",{groupId:t,duration:0});const n=l.querySelector(`.grp-item[data-group-id="${t}"]`);n&&n.classList.remove("muted","channel-muted"),t===window.selectedGroup&&g&&g.querySelectorAll(".channel-item").forEach((e=>{e.classList.remove("muted","channel-muted");const n=e.dataset.roomId,a=window.channelMuteUntil[t]&&window.channelMuteUntil[t][n];a&&Date.now()<a&&e.classList.add("muted","channel-muted")}))}})),Object.entries(window.channelMuteUntil||{}).forEach((([t,n])=>{n&&Object.entries(n).forEach((([n,a])=>{if(a!==1/0&&a&&Date.now()>a&&(delete window.channelMuteUntil[t][n],e.emit("muteChannel",{groupId:t,channelId:n,duration:0}),t===window.selectedGroup&&g)){const e=g.querySelector(`.channel-item[data-room-id="${n}"]`);e&&e.classList.remove("muted","channel-muted")}}))}))}),6e4),window.renderVoiceChannelGrid=E;const S=document.getElementById("channelContentArea"),k=()=>{"voice"===window.currentRoomType&&window.latestChannelsData&&window.currentRoom&&window.latestChannelsData[window.currentRoom]&&E(window.latestChannelsData[window.currentRoom].users)};S&&("ResizeObserver"in window?(window.channelAreaResizeObserver&&window.channelAreaResizeObserver.disconnect(),window.channelAreaResizeObserver=new ResizeObserver(k),window.channelAreaResizeObserver.observe(S)):(window.channelAreaResizeHandler&&window.removeEventListener("resize",window.channelAreaResizeHandler),window.channelAreaResizeHandler=k,window.addEventListener("resize",window.channelAreaResizeHandler))),e.on("connect",(()=>{d.info("Socket connected => "+e.id)})),e.on("disconnect",(()=>{d.warn("Socket disconnect")})),e.on("loginResult",(i=>{if(i.success){window.username=i.username;try{localStorage.setItem("username",i.username),i.token&&localStorage.setItem("token",i.token)}catch(e){}i.token&&(e.auth=e.auth||{},e.auth.token=i.token,e.connect(),e.once("connect",(()=>{e.emit("set-username",window.username)}))),t.style.display="none",n.style.display="flex",document.getElementById("userCardName").textContent=window.username,window.applyAudioStates(),window.loadAvatar(window.username).then((e=>{const t=document.getElementById("userCardAvatar");t&&(t.style.backgroundImage=`url(${e})`,t.dataset.username=window.username)}))}else a.textContent="Lütfen girdiğiniz bilgileri kontrol edip tekrar deneyin",a.style.display="block",o.classList.add("shake"),r.classList.add("shake")})),e.on("registerResult",(e=>{e.success?(alert("Hesap başarıyla oluşturuldu"),i.style.display="none",t.style.display="block"):(s.textContent=e.message||"Kayıt hatası",s.style.display="block")})),e.on("errorMessage",(e=>{"function"==typeof showToast?showToast(e):alert(e)})),e.on("groupUsers",(e=>{!function(e){const t=document.getElementById("userList");if(!t)return;t.innerHTML="";const n=document.createElement("div");if(n.textContent="Çevrimiçi",n.style.fontWeight="normal",n.style.fontSize="0.85rem",t.appendChild(n),e.online&&e.online.length>0)e.online.forEach((e=>{t.appendChild(oe(e.username))}));else{const e=document.createElement("p");e.textContent="(Kimse yok)",e.style.fontSize="0.75rem",t.appendChild(e)}const a=document.createElement("div");if(a.textContent="Çevrimdışı",a.style.fontWeight="normal",a.style.fontSize="0.85rem",a.style.marginTop="1rem",t.appendChild(a),e.offline&&e.offline.length>0)e.offline.forEach((e=>{t.appendChild(oe(e.username))}));else{const e=document.createElement("p");e.textContent="(Kimse yok)",e.style.fontSize="0.75rem",t.appendChild(e)}}(e)})),e.on("groupsList",(t=>{l.innerHTML="",t.forEach((t=>{const n=document.createElement("div");n.className="grp-item",n.setAttribute("data-group-id",t.id),n.innerText=t.name[0].toUpperCase(),n.title=t.name+" ("+t.id+")";let a=(t.unreadCount??t.unread??0)||window.unreadCounter&&window.unreadCounter[t.id]||0;const o=window.groupMuteUntil[t.id];o&&Date.now()<o&&(a=0);const r=window.mentionUnread[t.id]&&Object.keys(window.mentionUnread[t.id]).length>0;if(a>=1||r){const e=document.createElement("span");e.className="unread-dot",r&&e.classList.add("mention-dot"),n.appendChild(e),n.classList.add("unread")}t.id===window.selectedGroup&&n.classList.add("selected"),n.addEventListener("contextmenu",(e=>{e.preventDefault(),window.showGroupContextMenu(e,t)})),n.addEventListener("click",(()=>{document.querySelectorAll(".grp-item").forEach((e=>e.classList.remove("selected"))),n.classList.add("selected"),window.selectedGroup=t.id;try{localStorage.setItem("lastGroupId",t.id)}catch(e){console.warn("Unable to persist lastGroupId",e)}c.textContent=t.name,e.emit("joinGroup",t.id),"function"==typeof window.removeScreenShareEndedMessage&&window.removeScreenShareEndedMessage(),t.owner===window.username?(u.style.display="block",m.style.display="block"):(u.style.display="none",m.style.display="none"),p&&(p.style.display=t.owner===window.username?"block":"none"),w&&(w.style.display=t.owner===window.username?"none":"block")})),l.appendChild(n)}));const n=(()=>{try{return localStorage.getItem("lastGroupId")}catch(e){return null}})();if(n?ce(l.querySelector(`.grp-item[data-group-id="${n}"]`)):t.length>0&&ce(l.querySelector(`.grp-item[data-group-id="${t[0].id}"]`)),window.selectedGroup&&!t.some((e=>e.id===window.selectedGroup))){window.selectedGroup=null,window.currentGroup=null,window.currentRoom=null,window.currentTextChannel=null,window.currentRoomType=null,c.textContent="Seçili Grup",y.textContent="Kanal Seçilmedi",g.innerHTML="","function"==typeof window.hideVoiceSections&&window.hideVoiceSections(),h&&(h.style.display="none");const e=document.getElementById("channelUsersContainer");e&&(e.innerHTML="")}})),e.on("groupDeleted",(({groupId:e})=>{document.querySelectorAll(".grp-item").forEach((t=>{t.getAttribute("data-group-id")===e&&t.remove()})),window.selectedGroup===e&&(window.selectedGroup=null,c.textContent="Seçili Grup")})),e.on("groupUnreadReset",(({groupId:e})=>{const t=l.querySelector(`.grp-item[data-group-id="${e}"]`);if(t){const e=t.querySelector(".unread-dot");e&&e.remove(),t.classList.remove("unread")}window.unreadCounter[e]&&(window.unreadCounter[e]=0),window.mentionUnread[e]&&delete window.mentionUnread[e],e===window.selectedGroup&&g.querySelectorAll(".channel-item").forEach((e=>{const t=e.querySelector(".unread-dot");t&&t.remove(),e.classList.remove("unread")}))})),e.on("channelUnread",(({groupId:e,channelId:t})=>{const n=window.groupMuteUntil[e];if(n&&Date.now()<n)return;const a=window.channelMuteUntil[e]&&window.channelMuteUntil[e][t],o=g.querySelector(`.channel-item[data-room-id="${t}"]`)?.parentNode.closest(".category-row")?.dataset.categoryId,r=o&&window.categoryMuteUntil[e]&&window.categoryMuteUntil[e][o];if(!(a&&Date.now()<a||r&&Date.now()<r)&&(window.channelUnreadCounts[e]||(window.channelUnreadCounts[e]={}),window.channelUnreadCounts[e][t]=(window.channelUnreadCounts[e][t]||0)+1,e!==window.selectedGroup||t!==window.currentTextChannel)){window.unreadCounter[e]=(window.unreadCounter[e]||0)+1;const n=l.querySelector(`.grp-item[data-group-id="${e}"]`);if(n&&!n.querySelector(".unread-dot")){const e=document.createElement("span");e.className="unread-dot",n.appendChild(e)}if(n&&n.classList.add("unread"),e===window.selectedGroup){const e=g.querySelector(`.channel-item[data-room-id="${t}"]`);if(e&&!e.querySelector(".unread-dot")){const t=document.createElement("span");t.className="unread-dot",e.appendChild(t)}e&&e.classList.add("unread")}}})),e.on("mentionUnread",(({groupId:e,channelId:t})=>{window.mentionUnread[e]||(window.mentionUnread[e]={}),window.mentionUnread[e][t]=!0;const n=l.querySelector(`.grp-item[data-group-id="${e}"]`);if(n){let e=n.querySelector(".unread-dot");e||(e=document.createElement("span"),e.className="unread-dot",n.appendChild(e)),e.classList.add("mention-dot"),n.classList.add("unread")}if(e===window.selectedGroup){const e=g.querySelector(`.channel-item[data-room-id="${t}"]`);if(e){let t=e.querySelector(".unread-dot");t||(t=document.createElement("span"),t.className="unread-dot",e.appendChild(t)),t.classList.add("mention-dot"),e.classList.add("unread")}}})),e.on("channelRead",(({groupId:e,channelId:t})=>{window.unreadCounter[e]&&(window.unreadCounter[e]=Math.max(0,window.unreadCounter[e]-1)),window.channelUnreadCounts[e]&&(window.channelUnreadCounts[e][t]=0),window.mentionUnread[e]&&(delete window.mentionUnread[e][t],0===Object.keys(window.mentionUnread[e]).length&&delete window.mentionUnread[e]);const n=l.querySelector(`.grp-item[data-group-id="${e}"]`);if(n)if(0===window.unreadCounter[e]){const e=n.querySelector(".unread-dot");e&&e.remove(),n.classList.remove("unread")}else{const t=n.querySelector(".unread-dot");!t||window.mentionUnread[e]&&0!==Object.keys(window.mentionUnread[e]).length||t.classList.remove("mention-dot")}if(e===window.selectedGroup){const e=g.querySelector(`.channel-item[data-room-id="${t}"]`);if(e){const t=e.querySelector(".unread-dot");t&&(t.classList.remove("mention-dot"),t.remove()),e.classList.remove("unread")}}})),e.on("mentionCounts",(e=>{window.mentionUnread={},Object.entries(e||{}).forEach((([e,t])=>{Object.entries(t).forEach((([t,n])=>{Number(n)>0&&(window.mentionUnread[e]||(window.mentionUnread[e]={}),window.mentionUnread[e][t]=!0)}))}))})),e.on("unreadCounts",(e=>{window.unreadCounter=window.unreadCounter||{},window.channelUnreadCounts=e||{},Object.entries(e||{}).forEach((([e,t])=>{const n=Object.values(t).reduce(((e,t)=>e+(Number(t)||0)),0),a=window.groupMuteUntil[e],o=a&&Date.now()<a,r=l.querySelector(`.grp-item[data-group-id="${e}"]`);if(n>0&&!o){window.unreadCounter[e]=n;let t=r&&r.querySelector(".unread-dot");r&&!t&&(t=document.createElement("span"),t.className="unread-dot",r.appendChild(t)),t&&window.mentionUnread[e]&&Object.keys(window.mentionUnread[e]).length>0&&t.classList.add("mention-dot"),r&&r.classList.add("unread")}else if(r){const e=r.querySelector(".unread-dot");e&&e.remove(),r.classList.remove("unread")}e===window.selectedGroup&&Object.entries(t).forEach((([t,n])=>{const a=g.querySelector(`.channel-item[data-room-id="${t}"]`);if(!a)return;const r=window.channelMuteUntil[e]&&window.channelMuteUntil[e][t],i=o||r&&Date.now()<r;let d=a.querySelector(".unread-dot");n>0&&!i&&!d?(d=document.createElement("span"),d.className="unread-dot",a.appendChild(d)):(0===n||i)&&d&&d.remove(),n>0&&!i&&d&&window.mentionUnread[e]&&window.mentionUnread[e][t]&&d.classList.add("mention-dot"),n>0&&!i?a.classList.add("unread"):a.classList.remove("unread")}))}))}));const b=864e13;function M(e){const t=e.querySelector(".category-channels"),n=e.querySelector(".collapse-icon"),a=e.dataset.categoryId,o=de[a],r=t&&t.children.length>0;t&&(t.style.display=!o&&r?"flex":"none"),n&&(n.textContent=o?"chevron_right":"expand_more"),e.classList.toggle("expanded",!o&&r)}function T(e,t){let n=e.firstChild,a=document.createDocumentFragment();for(t.forEach((t=>{t===n?(a.firstChild&&(e.insertBefore(a,n),a=document.createDocumentFragment()),n=n.nextSibling):a.appendChild(t)})),a.firstChild&&e.insertBefore(a,n);n;){const e=n.nextSibling;n.remove(),n=e}}e.on("activeMutes",(e=>{window.groupMuteUntil=window.groupMuteUntil||{},window.channelMuteUntil=window.channelMuteUntil||{},window.categoryMuteUntil=window.categoryMuteUntil||{},Object.entries(e||{}).forEach((([e,t])=>{if(t.muteUntil){const n=new Date(t.muteUntil).getTime();window.groupMuteUntil[e]=n>=b?1/0:n;const a=l.querySelector(`.grp-item[data-group-id="${e}"]`);a&&a.classList.add("muted"),e===window.selectedGroup&&g.querySelectorAll(".channel-item").forEach((e=>e.classList.add("muted","channel-muted")))}t.channelMuteUntil&&(window.channelMuteUntil[e]||(window.channelMuteUntil[e]={}),Object.entries(t.channelMuteUntil).forEach((([t,n])=>{const a=new Date(n).getTime();if(window.channelMuteUntil[e][t]=a>=b?1/0:a,e===window.selectedGroup){const e=g.querySelector(`.channel-item[data-room-id="${t}"]`);e&&e.classList.add("muted","channel-muted")}}))),t.categoryMuteUntil&&(window.categoryMuteUntil[e]||(window.categoryMuteUntil[e]={}),Object.entries(t.categoryMuteUntil).forEach((([t,n])=>{const a=new Date(n).getTime();if(window.categoryMuteUntil[e][t]=a>=b?1/0:a,e===window.selectedGroup){const e=g.querySelector(`.category-row[data-category-id="${t}"]`);e&&e.classList.add("muted")}})))}))})),e.on("activeNotifyTypes",(e=>{window.groupNotifyType={},window.channelNotifyType={},Object.entries(e||{}).forEach((([e,t])=>{t.notificationType&&(window.groupNotifyType[e]=t.notificationType),t.channelNotificationType&&(window.channelNotifyType[e]=t.channelNotificationType)}))})),e.on("activeCategoryPrefs",(e=>{se=e.order||{},Object.entries(e.collapsed||{}).forEach((([e,t])=>{Object.entries(t).forEach((([e,t])=>{de[e]=!!t}))})),le()})),e.on("groupNotifyTypeUpdated",(({groupId:e,type:t})=>{e&&(window.groupNotifyType[e]=t,window.openNotifyTarget&&"group"===window.openNotifyType&&window.openNotifyTarget.dataset.groupId===e&&window.showNotificationSubMenu(window.openNotifyTarget,"group"))})),e.on("channelNotifyTypeUpdated",(({groupId:e,channelId:t,type:n})=>{e&&t&&(window.channelNotifyType[e]=window.channelNotifyType[e]||{},window.channelNotifyType[e][t]=n,window.openNotifyTarget&&"channel"===window.openNotifyType&&window.openNotifyTarget.dataset.channelId===t&&window.openNotifyTarget.dataset.groupId===e&&window.showNotificationSubMenu(window.openNotifyTarget,"channel"))})),e.on("groupMuted",(({groupId:e,muteUntil:t})=>{if(!e)return;if(t){const n=new Date(t).getTime();window.groupMuteUntil[e]=n>=b?1/0:n}else window.groupMuteUntil[e]=0;const n=l.querySelector(`.grp-item[data-group-id="${e}"]`);if(n){const e=n.querySelector(".unread-dot");e&&e.remove(),n.classList.remove("unread"),n.classList.add("muted")}window.unreadCounter[e]=0,e===window.selectedGroup&&(g.querySelectorAll(".channel-item").forEach((e=>{const t=e.querySelector(".unread-dot");t&&t.remove(),e.classList.remove("unread")})),window.channelUnreadCounts[e]&&Object.keys(window.channelUnreadCounts[e]).forEach((t=>{window.channelUnreadCounts[e][t]=0})))})),e.on("channelMuted",(({groupId:e,channelId:t,muteUntil:n})=>{if(e&&t){if(window.channelMuteUntil[e]||(window.channelMuteUntil[e]={}),n){const a=new Date(n).getTime();window.channelMuteUntil[e][t]=a>=b?1/0:a}else window.channelMuteUntil[e][t]=0;if(window.channelUnreadCounts[e]&&(window.channelUnreadCounts[e][t]=0),e===window.selectedGroup){const n=g.querySelector(`.channel-item[data-room-id="${t}"]`);if(n){const e=n.querySelector(".unread-dot");e&&e.remove(),n.classList.remove("unread"),n.classList.add("muted","channel-muted")}if(0===Object.values(window.channelUnreadCounts[e]||{}).reduce(((e,t)=>e+(Number(t)||0)),0)){const t=l.querySelector(`.grp-item[data-group-id="${e}"]`);if(t){const e=t.querySelector(".unread-dot");e&&e.remove(),t.classList.remove("unread"),t.classList.add("muted")}window.unreadCounter[e]=0}}}})),e.on("categoryMuted",(({groupId:e,categoryId:t,muteUntil:n})=>{if(e&&t){if(window.categoryMuteUntil[e]||(window.categoryMuteUntil[e]={}),n){const a=new Date(n).getTime();window.categoryMuteUntil[e][t]=a>=b?1/0:a}else window.categoryMuteUntil[e][t]=0;if(e===window.selectedGroup){const e=g.querySelector(`.category-row[data-category-id="${t}"]`);e&&e.classList.add("muted")}}})),e.on("muteCleared",(({groupId:e,channelId:t,categoryId:n})=>{if(t){window.channelMuteUntil[e]&&delete window.channelMuteUntil[e][t];const n=g.querySelector(`.channel-item[data-room-id="${t}"]`);n&&n.classList.remove("muted","channel-muted")}else if(n){window.categoryMuteUntil[e]&&delete window.categoryMuteUntil[e][n];const t=g.querySelector(`.category-row[data-category-id="${n}"]`);t&&t.classList.remove("muted")}else if(e){delete window.groupMuteUntil[e];const t=l.querySelector(`.grp-item[data-group-id="${e}"]`);t&&t.classList.remove("muted"),e===window.selectedGroup&&g.querySelectorAll(".channel-item").forEach((t=>{t.classList.remove("muted","channel-muted");const n=t.dataset.roomId,a=window.channelMuteUntil[e]&&window.channelMuteUntil[e][n];a&&Date.now()<a&&t.classList.add("muted","channel-muted")}))}})),e.on("categoryCollapseUpdated",(({groupId:e,categoryId:t,collapsed:n})=>{if(de[t]=n,le(),e===window.selectedGroup){const e=g.querySelector(`.category-row[data-category-id="${t}"]`);e&&M(e)}})),e.on("categoryOrderUpdated",(({groupId:e,order:t})=>{if(se[e]=t||{},e===window.selectedGroup){const e=Array.from(g.querySelectorAll(".category-row"));e.sort(((e,n)=>(t[e.dataset.categoryId]??0)-(t[n.dataset.categoryId]??0))),e.forEach((e=>g.appendChild(e)))}})),e.on("channelRenamed",(({channelId:e,newName:t})=>{const n=g.querySelector(`.channel-item[data-room-id="${e}"]`);if(n){const e=n.querySelector(".channel-header .channel-name");e&&(e.textContent=t)}})),e.on("channelDeleted",(({channelId:e})=>{const t=g.querySelector(`.channel-item[data-room-id="${e}"]`);t&&t.remove()})),e.on("roomsList",((t=[])=>{const n=window.currentTextChannel;window.channelUnreadCounts[window.selectedGroup]={};const a={};g.querySelectorAll(".category-row").forEach((e=>{a[e.dataset.categoryId]=e}));const o={};g.querySelectorAll(".channel-item").forEach((e=>{o[e.dataset.roomId]=e}));const r=[],i={},d={};t.forEach((t=>{if("category"===t.type){let n=a[t.id];n||(n=function(t){const n=document.createElement("div");n.className="category-row",n.dataset.categoryId=t.id;const a=document.createElement("div");a.className="category-header";const o=document.createElement("span");o.classList.add("material-icons","collapse-icon");const r=de[t.id];o.textContent=r?"chevron_right":"expand_more",n.classList.toggle("expanded",!r);const i=window.categoryMuteUntil[window.selectedGroup]&&window.categoryMuteUntil[window.selectedGroup][t.id],d=i&&Date.now()<i,s=document.createElement("span");s.className="category-name",s.textContent=t.name;const l=document.createElement("span");l.classList.add("material-icons","category-add-btn"),l.textContent="add",l.addEventListener("click",(e=>{e.stopPropagation(),window.createChannelTargetCategory=t.id,window.roomModal&&(window.roomModal.style.display="flex",window.roomModal.classList.add("active"))})),a.appendChild(s),a.appendChild(o),a.appendChild(l),d&&n.classList.add("muted"),n.appendChild(a);const c=document.createElement("div");var u;return c.className="category-channels",r&&(c.style.display="none"),n.appendChild(c),a.addEventListener("click",(()=>{de[t.id]=!de[t.id],le(),M(n),e.emit("setCategoryCollapsed",{groupId:window.selectedGroup,categoryId:t.id,collapsed:de[t.id]})})),a.addEventListener("contextmenu",(e=>{e.preventDefault(),window.showCategoryContextMenu(e,t)})),a.addEventListener("dragover",(a=>{ge&&(a.preventDefault(),"none"===c.style.display&&(c.style.display="flex",o.textContent="expand_more",n.classList.add("expanded"),de[t.id]=!1,le(),e.emit("setCategoryCollapsed",{groupId:window.selectedGroup,categoryId:t.id,collapsed:!1})),we&&we.parentNode!==c&&c.appendChild(we),fe(a.clientX,a.clientY))})),a.addEventListener("drop",(a=>{if(!ge||!we)return;a.preventDefault(),we.parentNode!==c&&c.appendChild(we),we.parentNode===c&&c.insertBefore(ge,we);const o=Array.from(g.querySelectorAll(".category-row, .channel-item")).indexOf(ge);ve(),we.remove(),we=null,ge.classList.remove("dragging"),e.emit("assignChannelCategory",{groupId:window.selectedGroup,channelId:ge.dataset.roomId,categoryId:t.id}),e.emit("reorderChannel",{groupId:window.selectedGroup,channelId:ge.dataset.roomId,newIndex:o}),ge.classList.add("snap");const r=ge;setTimeout((()=>r.classList.remove("snap")),150),ge=null,M(n)})),(u=n).setAttribute("draggable","true"),u.addEventListener("dragstart",(e=>{he=u,e.dataTransfer.effectAllowed="move",e.dataTransfer.setDragImage(new Image,0,0),ye=document.createElement("div"),ye.classList.add("category-placeholder"),u.parentNode.insertBefore(ye,u.nextSibling),u.classList.add("dragging")})),u.addEventListener("dragend",(()=>{ye&&ye.remove(),ye=null,u.classList.remove("dragging"),he=null})),M(n),n}(t)),i[t.id]=n.querySelector(".category-channels"),r.push(n)}else{let n=o[t.id];n?function(e,t){e.classList.toggle("voice-channel-item","voice"===t.type),e.dataset.roomId=t.id;let n=t.unreadCount??t.unread??0;const a=window.groupMuteUntil[window.selectedGroup],o=a&&Date.now()<a,r=window.channelMuteUntil[window.selectedGroup]&&window.channelMuteUntil[window.selectedGroup][t.id],i=r&&Date.now()<r;o||i?(n=0,e.classList.add("muted","channel-muted")):e.classList.remove("muted","channel-muted");const d=e.querySelector(".channel-header .channel-name");if(d&&(d.textContent=t.name),window.channelUnreadCounts[window.selectedGroup]||(window.channelUnreadCounts[window.selectedGroup]={}),"text"===t.type){window.channelUnreadCounts[window.selectedGroup][t.id]=n;let a=e.querySelector(".unread-dot");const r=window.mentionUnread[window.selectedGroup]&&window.mentionUnread[window.selectedGroup][t.id];n>0&&!o&&!i?(a||(a=document.createElement("span"),a.className="unread-dot",e.appendChild(a)),a.classList.toggle("mention-dot",Boolean(r)),e.classList.add("unread")):(a&&a.remove(),e.classList.remove("unread"))}}(n,t):(n=function(t){const n=document.createElement("div");n.className="channel-item",n.dataset.roomId=t.id;let a=t.unreadCount??t.unread??0;const o=window.groupMuteUntil[window.selectedGroup],r=o&&Date.now()<o,i=window.channelMuteUntil[window.selectedGroup]&&window.channelMuteUntil[window.selectedGroup][t.id],d=i&&Date.now()<i;if((r||d)&&(a=0,n.classList.add("muted","channel-muted")),"text"===t.type&&a>0){const e=document.createElement("span");e.className="unread-dot",window.mentionUnread[window.selectedGroup]&&window.mentionUnread[window.selectedGroup][t.id]&&e.classList.add("mention-dot"),n.appendChild(e),n.classList.add("unread")}window.channelUnreadCounts[window.selectedGroup]||(window.channelUnreadCounts[window.selectedGroup]={}),"text"===t.type&&(window.channelUnreadCounts[window.selectedGroup][t.id]=a),"voice"===t.type&&(n.classList.add("voice-channel-item"),n.addEventListener("dragover",(e=>e.preventDefault())),n.addEventListener("drop",(n=>{n.preventDefault(),me();const a=n.dataTransfer.getData("text/plain");a&&e.emit("moveUser",{userId:a,groupId:window.selectedGroup,roomId:t.id})})));const s=document.createElement("div");let l;s.className="channel-header","voice"===t.type?(l=document.createElement("span"),l.classList.add("material-icons","channel-icon"),l.textContent="volume_up"):(l=document.createElement("span"),l.classList.add("material-icons","channel-icon"),l.textContent="chat");const u=document.createElement("span");u.classList.add("channel-name"),u.textContent=t.name,s.appendChild(l),s.appendChild(u);const m=document.createElement("span");m.classList.add("material-icons","channel-settings-btn"),m.textContent="settings",s.appendChild(m);const p=document.createElement("div");return p.className="channel-users",p.id=`channel-users-${t.id}`,n.appendChild(s),n.appendChild(p),n.addEventListener("contextmenu",(e=>{e.preventDefault(),window.showChannelContextMenu(e,t)})),n.addEventListener("click",(()=>{if("text"===t.type){y.textContent=t.name,h.style.display="flex",h.style.flexDirection="column";const a=document.getElementById("channelUsersContainer");a&&(a.style.display="none",a.innerHTML=""),window.currentRoom&&"voice"===window.currentRoomType||(window.hideVoiceSections(),window.currentRoomType="text"),window.textMessages.innerHTML="",window.currentTextChannel=t.id,window.textMessages.dataset.channelId=t.id,e.emit("joinTextChannel",{groupId:window.selectedGroup,roomId:t.id});try{localStorage.setItem(`lastTextChannel:${window.selectedGroup}`,t.id)}catch(e){console.warn("Unable to persist last text channel",e)}return"function"==typeof window.removeScreenShareEndedMessage&&window.removeScreenShareEndedMessage(),document.querySelectorAll(".channel-item").forEach((e=>e.classList.remove("connected"))),void n.classList.add("connected")}if(window.clearScreenShareUI(),document.getElementById("channelUsersContainer").style.display="grid",document.querySelectorAll(".channel-item").forEach((e=>e.classList.remove("connected"))),window.currentRoom===t.id&&window.currentGroup===window.selectedGroup)return n.classList.add("connected"),window.updateVoiceChannelUI(t.name,!0),void(window.latestChannelsData&&window.latestChannelsData[t.id]&&E(window.latestChannelsData[t.id].users));!window.currentRoom||window.currentRoom===t.id&&window.currentGroup===window.selectedGroup||window.leaveRoomInternal(e),window.currentGroup=window.selectedGroup,A(e,window.applyAudioStates,{value:window.hasMic}).finally((()=>{const n=c?c.textContent:"";window.joinRoom(e,window.currentGroup,t.id,t.name,n,y,window.showChannelStatusPanel,{value:window.currentRoomType})})),n.classList.add("connected")})),n}(t),function(e){e.setAttribute("draggable","true"),e.addEventListener("dragstart",(t=>{var n;ge=e,t.dataTransfer.effectAllowed="move",t.dataTransfer.setDragImage(new Image,0,0),n=e.querySelector(".channel-header .channel-name")?.textContent||"",pe=document.createElement("div"),pe.classList.add("channel-drag-preview"),pe.textContent=n,document.body.appendChild(pe),we=document.createElement("div"),we.classList.add("channel-placeholder"),e.parentNode.insertBefore(we,e.nextSibling),e.classList.add("dragging")})),e.addEventListener("dragend",(()=>{ve(),we&&we.remove(),we=null,e.classList.remove("dragging"),ge=null}))}(n)),t.categoryId?(d[t.categoryId]||(d[t.categoryId]=[]),d[t.categoryId].push(n)):r.push(n)}})),T(g,r),Object.entries(i).forEach((([t,n])=>{T(n,d[t]||[]),Ce(e,n,g)})),g.querySelectorAll(".category-row").forEach(M),Ce(e,g,g);const s=l.querySelector(`.grp-item[data-group-id="${window.selectedGroup}"]`),u=Object.values(window.channelUnreadCounts[window.selectedGroup]||{}).reduce(((e,t)=>e+(Number(t)||0)),0);if(window.unreadCounter[window.selectedGroup]=u,s){let e=s.querySelector(".unread-dot");u>0?(e||(e=document.createElement("span"),e.className="unread-dot",s.appendChild(e)),s.classList.add("unread")):(e&&e.remove(),s.classList.remove("unread"))}if(n&&t.some((e=>e.id===n))){const e=g.querySelector(`.channel-item[data-room-id="${n}"]`);return void(e&&e.classList.add("connected"))}const m=(()=>{try{return localStorage.getItem(`lastTextChannel:${window.selectedGroup}`)}catch(e){return null}})();let p=null;if(m&&t.some((e=>e.id===m&&"text"===e.type)))p=m;else{const e=t.find((e=>"text"===e.type));e&&(p=e.id)}if(p){const e=g.querySelector(`.channel-item[data-room-id="${p}"]`);e&&e.click()}})),e.on("joinRoomAck",(({groupId:t,roomId:n})=>{window.currentGroup=t,window.currentRoom=n,window.currentRoomType="voice","function"==typeof window.showChannelStatusPanel&&window.showChannelStatusPanel(),L&&I?U(e,window.currentGroup,window.currentRoom):A(e,window.applyAudioStates,{value:window.hasMic}).finally((()=>{U(e,window.currentGroup,window.currentRoom)}))})),e.on("newProducer",(({producerId:t})=>{C&&q(e,window.currentGroup,window.currentRoom,t)})),e.on("screenShareEnded",(({userId:t,username:n})=>{"function"==typeof window.clearScreenShareUI&&window.clearScreenShareUI();const a=document.querySelector(".channel-content-area");B&&a&&a.contains(B)?a.removeChild(B):x&&a&&a.contains(x)&&a.removeChild(x),window.screenShareVideo&&window.screenShareVideo.dataset.peerId===t&&e.emit("stopWatching",{userId:t}),window.screenShareVideo=null,window.screenShareContainer=null;const o=t===e.id?"Yayınınız sonlandırıldı":`${n||"Bir kullanıcı"} adlı kullanıcının yayını sonlandırıldı`;window.displayScreenShareEndedMessage(o)})),e.on("screenShareWatchers",(e=>{window.screenShareWatchers=e,window.latestChannelsData&&f(window.latestChannelsData)})),e.on("roomUsers",(e=>{"voice"===window.currentRoomType&&E(e)})),e.on("allChannelsData",(e=>{window.latestChannelsData=e,f(e),"voice"===window.currentRoomType&&window.currentRoom&&e[window.currentRoom]&&E(e[window.currentRoom].users)})),e.on("avatarUpdated",(({username:e,avatar:t})=>{window.userAvatars[e]=t,document.querySelectorAll(`[data-username="${e}"]`).forEach((e=>{"IMG"===e.tagName?e.src=t||"/images/default-avatar.png":e.style.backgroundImage=`url(${t||"/images/default-avatar.png"})`}))})),e.on("forceLogout",(()=>{n.style.display="none",t.style.display="block",window.username=null}))}function Le(e){const t=document.querySelector("#userSettingsPage .settings-content");t&&("Hesabım"===e?(t.innerHTML='\n      <h1 class="account-title">Hesabım</h1>\n      <div class="account-tabs">\n        <button class="account-tab active">Güvenlik</button>\n        <button class="account-tab">Durum</button>\n      </div>\n      <div class="account-card">\n        <div class="cover-strip"></div>\n        <div class="profile-block">\n          <div class="profile-avatar" id="profile-avatar">\n            <img id="avatarImage" src="/images/default-avatar.png" alt="" />\n            <div class="avatar-overlay"><span class="material-symbols-outlined">edit</span></div>\n          </div>\n          <h1 class="display-name" id="displayNameHeading">Gösterim Adı</h1>\n          <button class="edit-profile-btn">Kullanıcı Profilini Düzenle</button>\n        </div>\n        <div class="info-card">\n          <div class="info-row" id="displayNameRow" data-label="Görünen Ad" data-field="displayName">\n            <div>\n              <div class="info-label">Görünen Ad</div>\n              <div class="info-value">Kullanıcının Görünen Adı</div>\n            </div>\n            <button class="edit-btn" id="editDisplayNameBtn">Düzenle</button>\n          </div>\n        <div class="info-row" id="userHandleRow" data-label="Kullanıcı adı" data-field="username">\n          <div>\n            <div class="info-label">Kullanıcı adı</div>\n            <div class="info-value">Kullanıcının Kullanıcı Adı</div>\n          </div>\n          <button class="edit-btn" id="editUserHandleBtn">Düzenle</button>\n        </div>\n        <div class="info-row" id="emailRow" data-label="E-Posta" data-field="email">\n          <div>\n            <div class="info-label">E-Posta</div>\n            <div class="info-value">**********@gmail.com</div>\n          </div>\n          <button class="edit-btn" id="editEmailBtn">Düzenle</button>\n        </div>\n        <div class="info-row" id="phoneRow" data-label="Telefon Numarası" data-field="phone">\n          <div>\n            <div class="info-label">Telefon Numarası</div>\n            <div class="info-value">+90 5** *** ** **</div>\n          </div>\n          <div class="info-actions">\n            <div class="remove-link" id="removePhoneLink">Kaldır</div>\n            <button class="edit-btn" id="editPhoneBtn">Düzenle</button>\n          </div>\n        </div>\n      </div>\n      </div>',function(){const e=(()=>{try{return localStorage.getItem("username")}catch(e){return null}})();if(e){const t=window.getAuthToken();fetch("/api/user/me",{headers:t?{Authorization:`Bearer ${t}`}:void 0}).then((e=>e.ok?e.json():null)).then((e=>{if(!e)return;const t=document.getElementById("displayNameHeading");t&&(t.textContent=e.displayName||"");const n=(e,t)=>{const n=document.querySelector(`#${e} .info-value`);n&&(n.textContent=t||"—")};n("displayNameRow",e.displayName),n("userHandleRow",e.username),n("emailRow",e.email),n("phoneRow",e.phone)})).catch((()=>{})),window.loadAvatar(e).then((e=>{const t=document.getElementById("avatarImage");t&&(t.src=e)}))}const t=document.getElementById("editEmailBtn"),n=document.getElementById("editPhoneBtn"),a=document.getElementById("editUserHandleBtn"),o=document.getElementById("removePhoneLink"),r=document.getElementById("profile-avatar");a&&a.addEventListener("click",Be),t&&t.addEventListener("click",Me),n&&n.addEventListener("click",Te),o&&o.addEventListener("click",(()=>ke("removePhoneConfirmModal"))),r&&r.addEventListener("click",(()=>ke("avatarUploadModal")));const i=document.getElementById("closeAvatarUploadModal"),d=document.getElementById("avatarFileInput"),s=document.getElementById("saveAvatarBtn"),l=document.getElementById("avatarCropContainer"),c=document.getElementById("cancelAvatarUploadBtn");i&&i.addEventListener("click",(()=>{Ae&&(Ae.destroy(),Ae=null),be("avatarUploadModal")})),c&&c.addEventListener("click",(()=>be("avatarUploadModal"))),d&&d.addEventListener("change",(()=>{const e=d.files[0];if(!e)return;if(e.size>2097152)return alert("Dosya 2 MB'dan büyük"),void(d.value="");const t=URL.createObjectURL(e);l.innerHTML=`<img id="avatarCropImage" src="${t}" />`;const n=document.getElementById("avatarCropImage");Ae&&Ae.destroy(),Ae=new Cropper(n,{aspectRatio:1})})),s&&s.addEventListener("click",(()=>{if(!Ae)return;const e=Ae.getCroppedCanvas({width:256,height:256});if(!e)return void console.error("Failed to crop avatar: canvas is null");const t=e.toDataURL("image/png"),n=document.getElementById("avatarImage");n&&(n.src=t);const a=localStorage.getItem("username"),o=window.getAuthToken();fetch(`/api/user/avatar?username=${encodeURIComponent(a)}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:o?`Bearer ${o}`:void 0},body:JSON.stringify({avatar:t})}).then((()=>{try{localStorage.setItem("avatar",t)}catch(e){}})).catch((()=>{})),Ae.destroy(),Ae=null,be("avatarUploadModal")}));const u=document.getElementById("cancelRemovePhoneBtn"),m=document.getElementById("confirmRemovePhoneBtn"),p=document.getElementById("closeRemovePhoneConfirmModal");p&&p.addEventListener("click",(()=>be("removePhoneConfirmModal"))),u&&u.addEventListener("click",(()=>be("removePhoneConfirmModal"))),m&&m.addEventListener("click",(()=>{const e=document.querySelector("#phoneRow .info-value");e&&(e.textContent="—"),localStorage.getItem("username");const t=window.getAuthToken();fetch("/api/user/me",{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:void 0},body:JSON.stringify({field:"phone",value:""})}).catch((()=>{})),be("removePhoneConfirmModal")}));const w=document.querySelector(".edit-profile-btn");if(w){const e=document.getElementById("userSettingsPage"),t=e?e.querySelector('.settings-menu li[data-section="profile"]'):null,n=e?e.querySelectorAll(".settings-menu li"):[];w.addEventListener("click",(()=>{if(t){n.forEach((e=>e.classList.remove("active"))),t.classList.add("active"),Le(t.textContent.trim());try{localStorage.setItem("lastSettingsTab",t.dataset.section||t.textContent.trim())}catch(e){}}}))}}()):t.innerHTML=`<h2>${e}</h2>`)}const Se=["editUsernameModal","editEmailModal","editPhoneModal","removePhoneConfirmModal","avatarUploadModal","removeAvatarModal"];function ke(e){const t=document.getElementById(e);t&&(t.style.display="flex",t.classList.add("active"),Se.includes(e)&&document.body.classList.add("blurred"),t._untrap=function(e){const t=Array.from(e.querySelectorAll('a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])'));if(!t.length)return()=>{};const n=t[0],a=t[t.length-1];function o(e){"Tab"===e.key&&(e.shiftKey?document.activeElement===n&&(e.preventDefault(),a.focus()):document.activeElement===a&&(e.preventDefault(),n.focus()))}return e.addEventListener("keydown",o),setTimeout((()=>n.focus()),0),()=>e.removeEventListener("keydown",o)}(t))}function be(e){const t=document.getElementById(e);t&&(t.style.display="none",t.classList.remove("active"),"function"==typeof t._untrap&&(t._untrap(),t._untrap=null),Se.includes(e))&&(Se.some((e=>{const t=document.getElementById(e);return t&&t.classList.contains("active")}))||document.body.classList.remove("blurred"))}function xe(e){const t=document.getElementById("toast");t&&(t.textContent=e,t.style.display="block",setTimeout((()=>{t.style.display="none"}),2e3))}function Be(){const e=document.getElementById("editUsernameModal");if(!e)return;const t=e.querySelector("input"),n=e.querySelector(".modal-buttons .btn.primary"),a=e.querySelector(".modal-buttons .btn.secondary"),o=e.querySelector(".modal-error"),r=e.querySelector(".close-modal");function i(e){o&&(o.textContent=e,o.style.display="block")}function d(){be("editUsernameModal"),document.removeEventListener("keydown",s),t&&t.removeEventListener("input",l)}function s(e){"Escape"===e.key&&d()}function l(){o&&(o.textContent="",o.style.display="none"),n&&(n.disabled=""===t.value.trim())}r&&r.addEventListener("click",d,{once:!0}),a&&a.addEventListener("click",d,{once:!0}),document.addEventListener("keydown",s),t&&(t.addEventListener("input",l),t.addEventListener("keydown",(e=>{"Enter"===e.key&&n&&!n.disabled&&n.click()}))),n&&(n.addEventListener("click",(async function e(){if(n.disabled)return;const a=t.value.trim();if(!a)return void i("Bu alan boş bırakılamaz");n.disabled=!0;const o=n.innerHTML;n.innerHTML='<span class="spinner"></span>';try{localStorage.getItem("username");const e=window.getAuthToken(),t=await fetch("/api/user/me",{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:e?`Bearer ${e}`:void 0},body:JSON.stringify({field:"username",value:a})});if(!t.ok){const e=await t.json().catch((()=>({})));return void("invalid_username"===e.error?i("Geçersiz kullanıcı adı"):"username_taken"===e.error?i("Bu kullanıcı adı kullanımda"):i(e.error||"Sunucu hatası"))}const n=document.querySelector("#userHandleRow .info-value");n&&(n.textContent=a);try{localStorage.setItem("username",a)}catch(e){}xe("Changes saved"),d()}catch(e){i("Sunucu hatası")}finally{n.innerHTML=o,n.disabled=!1,n.removeEventListener("click",e)}}),{once:!0}),n.disabled=""===t.value.trim()),ke("editUsernameModal")}function Me(){const e=document.getElementById("editEmailModal");if(!e)return;const t=e.querySelector("input"),n=e.querySelector(".modal-buttons .btn.primary"),a=e.querySelector(".modal-buttons .btn.secondary"),o=e.querySelector(".modal-error"),r=e.querySelector(".close-modal");function i(e){o&&(o.textContent=e,o.style.display="block")}function d(){be("editEmailModal"),document.removeEventListener("keydown",s),t&&t.removeEventListener("input",l)}function s(e){"Escape"===e.key&&d()}function l(){o&&(o.textContent="",o.style.display="none"),n&&(n.disabled=""===t.value.trim())}r&&r.addEventListener("click",d,{once:!0}),a&&a.addEventListener("click",d,{once:!0}),document.addEventListener("keydown",s),t&&(t.addEventListener("input",l),t.addEventListener("keydown",(e=>{"Enter"===e.key&&n&&!n.disabled&&n.click()}))),n&&(n.addEventListener("click",(async function e(){if(n.disabled)return;const a=t.value.trim();if(!a)return void i("Bu alan boş bırakılamaz");n.disabled=!0;const o=n.innerHTML;n.innerHTML='<span class="spinner"></span>';try{localStorage.getItem("username");const e=window.getAuthToken(),t=await fetch("/api/user/me",{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:e?`Bearer ${e}`:void 0},body:JSON.stringify({field:"email",value:a})});if(!t.ok)return void i((await t.json().catch((()=>({})))).error||"Sunucu hatası");const n=document.querySelector("#emailRow .info-value");n&&(n.textContent=a),xe("Changes saved"),d()}catch(e){i("Sunucu hatası")}finally{n.innerHTML=o,n.disabled=!1,n.removeEventListener("click",e)}}),{once:!0}),n.disabled=""===t.value.trim()),ke("editEmailModal")}function Te(){const e=document.getElementById("editPhoneModal");if(!e)return;const t=e.querySelector("input"),n=e.querySelector(".modal-buttons .btn.primary"),a=e.querySelector(".modal-buttons .btn.secondary"),o=e.querySelector(".modal-error"),r=e.querySelector(".close-modal");function i(e){o&&(o.textContent=e,o.style.display="block")}function d(){be("editPhoneModal"),document.removeEventListener("keydown",s),t&&t.removeEventListener("input",l)}function s(e){"Escape"===e.key&&d()}function l(){o&&(o.textContent="",o.style.display="none"),n&&(n.disabled=""===t.value.trim())}r&&r.addEventListener("click",d,{once:!0}),a&&a.addEventListener("click",d,{once:!0}),document.addEventListener("keydown",s),t&&(t.addEventListener("input",l),t.addEventListener("keydown",(e=>{"Enter"===e.key&&n&&!n.disabled&&n.click()}))),n&&(n.addEventListener("click",(async function e(){if(n.disabled)return;const a=t.value.trim();if(!a)return void i("Bu alan boş bırakılamaz");n.disabled=!0;const o=n.innerHTML;n.innerHTML='<span class="spinner"></span>';try{localStorage.getItem("username");const e=window.getAuthToken(),t=await fetch("/api/user/me",{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:e?`Bearer ${e}`:void 0},body:JSON.stringify({field:"phone",value:a})});if(!t.ok)return void i((await t.json().catch((()=>({})))).error||"Sunucu hatası");const n=document.querySelector("#phoneRow .info-value");n&&(n.textContent=a),xe("Changes saved"),d()}catch(e){i("Sunucu hatası")}finally{n.innerHTML=o,n.disabled=!1,n.removeEventListener("click",e)}}),{once:!0}),n.disabled=""===t.value.trim()),ke("editPhoneModal")}window.showToast=xe;let Ae=null;function Ue(){const e=document.getElementById("userSettingsPage");if(!e)return;const t=e.querySelectorAll(".settings-menu li"),n=e.querySelector('.settings-menu li[data-section="logout"]'),a=document.getElementById("logoutConfirmModal"),o=document.getElementById("confirmLogoutBtn"),r=document.getElementById("cancelLogoutBtn"),i=(()=>{try{return localStorage.getItem("lastSettingsTab")}catch(e){return null}})();let d=i?e.querySelector(`.settings-menu li[data-section="${i}"]`):null;d||(d=e.querySelector('.settings-menu li[data-section="account"]')),d&&(t.forEach((e=>e.classList.remove("active"))),d.classList.add("active"),Le(d.textContent.trim())),e.dataset.initialized||(t.forEach((e=>{e.addEventListener("click",(()=>{if(e!==n){t.forEach((e=>e.classList.remove("active"))),e.classList.add("active"),Le(e.textContent.trim());try{localStorage.setItem("lastSettingsTab",e.dataset.section||e.textContent.trim())}catch(e){}}else a&&(a.style.display="flex")}))})),o&&o.addEventListener("click",(()=>{a&&(a.style.display="none"),Ne();try{localStorage.removeItem("username")}catch(e){}window.location.reload()})),r&&r.addEventListener("click",(()=>{a&&(a.style.display="none")})),e.dataset.initialized="true")}function Ne(){const e=document.getElementById("userSettingsPage"),t=document.getElementById("callScreen");e&&(e.style.display="none"),t&&(t.style.display="flex")}function De(){if(document.querySelector(".channel-content-area"),B?(B.parentNode&&B.parentNode.removeChild(B),T(null),M(null)):x&&(x.parentNode&&x.parentNode.removeChild(x),M(null)),!window.screenShareProducerVideo&&Ut){Ut.classList.remove("active");const e=Ut.querySelector(".material-icons");e&&(e.textContent="desktop_windows")}if(!window.screenShareProducerVideo&&Dt){Dt.classList.remove("active");const e=Dt.querySelector(".material-icons, .material-icons-outlined");e&&(e.textContent="desktop_windows")}const e=document.getElementById("screenShareOverlay");e&&e.parentNode&&e.parentNode.removeChild(e),window.removeScreenShareEndedMessage&&window.removeScreenShareEndedMessage();const t=document.getElementById("channelUsersContainer");t&&(t.classList.remove("broadcast-mode"),t.style.display="grid",t.style.flexDirection="",t.style.justifyContent=""),window.broadcastingUserId=null,window.latestChannelsData&&window.currentRoom&&"function"==typeof window.renderVoiceChannelGrid&&window.latestChannelsData[window.currentRoom]&&window.renderVoiceChannelGrid(window.latestChannelsData[window.currentRoom].users)}window.clearScreenShareUI=De;let Ge=null,qe=localStorage.getItem("lastGroupId")||null;window.getAuthToken=function(){try{const e=localStorage.getItem("token");if(e)return e}catch(e){}return Ge&&Ge.auth&&Ge.auth.token?Ge.auth.token:null},"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then((e=>{window.swRegistration=e})).catch((e=>console.warn("Service worker registration failed",e))),window.cacheUploadUrls=function(e){if(!Array.isArray(e)||!e.length||!navigator.serviceWorker)return;const t=t=>{t.active&&t.active.postMessage({type:"cache-uploads",urls:e})};window.swRegistration?t(window.swRegistration):navigator.serviceWorker.getRegistration("/sw.js").then((e=>{e&&t(e)}))},window.userAvatars={},window.loadAvatar=async function(e){if(!e)return null;if(window.userAvatars[e])return window.userAvatars[e];try{let t=window.getAuthToken(),n=t?{Authorization:`Bearer ${t}`}:void 0,a=await fetch(`/api/user/avatar?username=${encodeURIComponent(e)}`,{headers:n});if(401===a.status){const n=window.getAuthToken();!t&&n&&(a=await fetch(`/api/user/avatar?username=${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${n}`}}))}if(a.ok){const t=await a.json();window.userAvatars[e]=t.avatar||"/images/default-avatar.png"}else window.userAvatars[e]="/images/default-avatar.png"}catch(t){window.userAvatars[e]="/images/default-avatar.png"}return window.userAvatars[e]},window.groupNotifyType={},window.channelNotifyType={},window.openNotifyTarget=null,window.openNotifyType=null;const Re=document.getElementById("loginScreen"),Pe=document.getElementById("registerScreen"),$e=document.getElementById("callScreen"),ze=document.getElementById("loginUsernameInput"),He=document.getElementById("loginPasswordInput"),je=document.getElementById("loginForm"),Oe=document.getElementById("loginButton"),_e=document.getElementById("loginErrorMessage"),Ve=document.getElementById("regUsernameInput"),Fe=document.getElementById("regNameInput"),We=document.getElementById("regSurnameInput"),Ye=document.getElementById("regBirthdateInput"),Ke=document.getElementById("regEmailInput"),Je=document.getElementById("regPhoneInput"),Xe=document.getElementById("regPasswordInput"),Qe=document.getElementById("regPasswordConfirmInput"),Ze=document.getElementById("registerButton"),et=document.getElementById("backToLoginButton"),tt=document.getElementById("registerErrorMessage"),nt=document.getElementById("showRegisterScreen"),at=document.getElementById("showLoginScreen"),ot=document.getElementById("groupList"),rt=document.getElementById("createGroupButton"),it=document.getElementById("roomList"),dt=document.getElementById("groupTitle"),st=document.getElementById("groupDropdownIcon"),lt=document.getElementById("groupDropdownMenu"),ct=document.getElementById("copyGroupIdBtn"),ut=document.getElementById("renameGroupBtn"),mt=document.getElementById("createChannelBtn"),pt=document.getElementById("deleteGroupBtn"),wt=document.getElementById("groupSettingsBtn"),gt=document.getElementById("leaveGroupBtn"),yt=document.getElementById("toggleDMButton"),ht=document.getElementById("roomPanel"),ft=document.getElementById("rightPanel"),vt=(document.getElementById("userList"),document.getElementById("toggleUserListButton")),Et=document.getElementById("channelStatusPanel");Et.style.zIndex="20",Et.style.display="flex";const Ct=document.getElementById("connectionStatusText"),It=(document.getElementById("pingValue"),document.getElementById("cellBar1"),document.getElementById("cellBar2"),document.getElementById("cellBar3"),document.getElementById("cellBar4"),Et.querySelector(".connection-header")),Lt=Et.querySelector(".channel-info-row"),St=Et.querySelector(".button-row"),kt=Et.querySelector(".panel-divider"),bt=Et.querySelector(".user-card");function xt(){It&&(It.style.display="flex"),Lt&&(Lt.style.display="flex"),St&&(St.style.display="flex"),kt&&(kt.style.display="block"),bt&&(bt.style.display="flex")}function Bt(){It&&(It.style.display="none"),Lt&&(Lt.style.display="none"),St&&(St.style.display="none"),kt&&(kt.style.display="none"),bt&&(bt.style.display="flex")}function Mt(e){Ct&&(Ct.classList.remove("status-connected","status-connecting"),"connected"===e?(Ct.textContent="Kanala bağlanıldı",Ct.classList.add("status-connected")):(Ct.textContent="RTC Bağlanıyor",Ct.classList.add("status-connecting")))}function Tt(){"voice"===window.currentRoomType&&(Et&&(Et.style.display="flex",xt()),Mt("connecting"),m(0),function(e){const t=document.getElementById("pingValue");c&&clearInterval(c),c=setInterval((()=>{let n=0;e&&e.io&&e.io.engine&&e.io.engine.lastPingTimestamp?(n=Date.now()-e.io.engine.lastPingTimestamp,t&&(t.textContent=n+" ms")):t&&(t.textContent=""),m(n),u(n)}),1e3)}(Ge))}window.showChannelStatusPanel=Tt,window.hideChannelStatusPanel=function(){Et&&(Et.style.display="none"),function(){const e=document.getElementById("pingValue");c&&(clearInterval(c),c=null),e&&(e.textContent=""),u(0)}()},window.setConnectionStatus=Mt,window.showVoiceSections=xt,window.hideVoiceSections=Bt;const At=document.getElementById("leaveButton"),Ut=document.getElementById("screenShareButton"),Nt=document.getElementById("cameraShareButton"),Dt=document.getElementById("screenShareLargeButton"),Gt=document.getElementById("soundbarButton"),qt=document.getElementById("micToggleButton"),Rt=document.getElementById("deafenToggleButton"),Pt=document.getElementById("settingsButton"),$t=document.getElementById("textChannelContainer"),zt=document.getElementById("textMessages"),Ht=document.getElementById("textChatInputBar"),jt=document.getElementById("textChannelMessageInput"),Ot=document.getElementById("micMessageBtn"),_t=document.getElementById("sendTextMessageBtn"),Vt=document.getElementById("selectedChannelTitle"),Ft=document.getElementById("channelContentArea"),Wt=document.getElementById("dmContentArea"),Yt=document.getElementById("dmPanel"),Kt=document.getElementById("groupModal"),Jt=document.getElementById("modalGroupCreateBtn"),Xt=document.getElementById("modalGroupJoinBtn"),Qt=document.getElementById("actualGroupCreateModal"),Zt=document.getElementById("actualGroupName"),en=document.getElementById("actualGroupNameBtn"),tn=document.getElementById("closeCreateGroupModal"),nn=document.getElementById("joinGroupModal"),an=document.getElementById("joinGroupIdInput"),on=document.getElementById("joinGroupIdBtn"),rn=document.getElementById("closeJoinGroupModal"),dn=document.getElementById("groupSettingsModal"),sn=document.getElementById("closeGroupSettingsModal"),ln=document.getElementById("userSettingsPage"),cn=document.getElementById("closeUserSettingsPageBtn"),un=document.getElementById("roomModal"),mn=document.getElementById("modalRoomName"),pn=document.getElementById("textChannel"),wn=document.getElementById("voiceChannel"),gn=document.getElementById("modalCreateRoomBtn"),yn=document.getElementById("modalCloseRoomBtn"),hn=document.getElementById("createCategoryBtn"),fn=document.getElementById("categoryModal"),vn=document.getElementById("modalCategoryName"),En=document.getElementById("modalCreateCategoryBtn"),Cn=document.getElementById("modalCloseCategoryBtn");Object.assign(window,{loginScreen:Re,registerScreen:Pe,callScreen:$e,loginUsernameInput:ze,loginPasswordInput:He,loginForm:je,loginButton:Oe,loginErrorMessage:_e,regUsernameInput:Ve,regNameInput:Fe,regSurnameInput:We,regBirthdateInput:Ye,regEmailInput:Ke,regPhoneInput:Je,regPasswordInput:Xe,regPasswordConfirmInput:Qe,registerButton:Ze,backToLoginButton:et,registerErrorMessage:tt,showRegisterScreen:nt,showLoginScreen:at,groupListDiv:ot,createGroupButton:rt,roomListDiv:it,groupTitle:dt,groupDropdownIcon:st,groupDropdownMenu:lt,copyGroupIdBtn:ct,renameGroupBtn:ut,createChannelBtn:mt,groupSettingsBtn:wt,leaveGroupBtn:gt,deleteGroupBtn:pt,toggleDMButton:yt,roomPanel:ht,rightPanel:ft,leaveButton:At,screenShareButton:Ut,micToggleButton:qt,deafenToggleButton:Rt,settingsButton:Pt,textChannelContainer:$t,textMessages:zt,textChatInputBar:Ht,textChannelMessageInput:jt,micMessageBtn:Ot,sendTextMessageBtn:_t,selectedChannelTitle:Vt,channelContentArea:Ft,dmContentArea:Wt,dmPanel:Yt,cameraShareButton:Nt,screenShareLargeButton:Dt,toggleUserListButton:vt,soundbarButton:Gt,groupModal:Kt,modalGroupCreateBtn:Jt,modalGroupJoinBtn:Xt,actualGroupCreateModal:Qt,actualGroupName:Zt,actualGroupNameBtn:en,closeCreateGroupModal:tn,joinGroupModal:nn,joinGroupIdInput:an,joinGroupIdBtn:on,closeJoinGroupModal:rn,groupSettingsModal:dn,closeGroupSettingsModal:sn,userSettingsPage:ln,closeUserSettingsPageBtn:cn,roomModal:un,modalRoomName:mn,textChannel:pn,voiceChannel:wn,modalCreateRoomBtn:gn,modalCloseRoomBtn:yn,createCategoryBtn:hn,categoryModal:fn,modalCategoryName:vn,modalCreateCategoryBtn:En,modalCloseCategoryBtn:Cn}),window.WebRTC=r,window.joinRoom=P,window.leaveRoomInternal=R;const In=window.leaveRoomInternal;function Ln(e,t){const n=document.getElementById("muteSubMenu");n&&n.remove();const a=document.createElement("div");a.id="muteSubMenu",a.className="context-menu",a.style.position="absolute";const o=e.getBoundingClientRect();a.style.top=o.top+"px",a.style.left=o.right+"px",a.style.display="flex",a.style.flexDirection="column",[{label:"15 dakika",ms:9e5},{label:"30 dakika",ms:18e5},{label:"1 saat",ms:36e5},{label:"3 saat",ms:108e5},{label:"8 saat",ms:288e5},{label:"24 saat",ms:864e5},{label:"Ben tekrar açana kadar",ms:-1}].forEach((n=>{const o=document.createElement("div");o.className="context-menu-item",o.textContent=n.label,o.addEventListener("click",(()=>{if("channel"===t){const t=window.selectedGroup,a=e.dataset.channelId;if(Ge.emit("muteChannel",{groupId:t,channelId:a,duration:n.ms}),window.channelMuteUntil[t]||(window.channelMuteUntil[t]={}),n.ms>0?window.channelMuteUntil[t][a]=Date.now()+n.ms:-1===n.ms?window.channelMuteUntil[t][a]=1/0:delete window.channelMuteUntil[t][a],t===window.selectedGroup){const e=document.querySelector(`.channel-item[data-room-id="${a}"]`);e&&(n.ms>0||-1===n.ms?e.classList.add("muted","channel-muted"):e.classList.remove("muted","channel-muted"))}}else if("group"===t){const t=e.dataset.groupId;Ge.emit("muteGroup",{groupId:t,duration:n.ms})}else if("category"===t){const t=e.dataset.categoryId;Ge.emit("muteCategory",{groupId:window.selectedGroup,categoryId:t,duration:n.ms})}a.remove();const o="channel"===t?"channelContextMenu":"group"===t?"groupContextMenu":"categoryContextMenu",r=document.getElementById(o);r&&r.remove()})),a.appendChild(o)})),document.body.appendChild(a);const r=t=>{const n=t.relatedTarget;e.contains(n)||a.contains(n)||(a.remove(),e.removeEventListener("mouseleave",r),a.removeEventListener("mouseleave",r))};e.addEventListener("mouseleave",r),a.addEventListener("mouseleave",r),document.addEventListener("click",(function e(){const t=document.getElementById("muteSubMenu");t&&t.remove(),document.removeEventListener("click",e)}))}function Sn(e,t){const n=document.getElementById("notifySubMenu");n&&n.remove(),window.openNotifyTarget=e,window.openNotifyType=t;const a=document.createElement("div");a.id="notifySubMenu",a.className="context-menu",a.style.position="absolute";const o=e.getBoundingClientRect();a.style.top=o.top+"px",a.style.left=o.right+"px",a.style.display="flex",a.style.flexDirection="column";const r="group"===t?e.dataset.groupId:window.selectedGroup,i="channel"===t?e.dataset.channelId:null;let d="all";"channel"===t&&window.channelNotifyType[r]?d=window.channelNotifyType[r][i]||d:"group"===t&&(d=window.groupNotifyType[r]||d),[{label:"Bütün mesajlar",value:"all"},{label:"Sadece bahsetmeler",value:"mentions"},{label:"Hiçbir şey",value:"nothing"}].forEach((e=>{const n=document.createElement("div");if(n.className="context-menu-item",n.textContent=e.label,e.value===d){const e=document.createElement("span");e.classList.add("material-icons"),e.textContent="check",n.appendChild(e)}n.addEventListener("click",(()=>{"channel"===t?(Ge.emit("setChannelNotifyType",{groupId:r,channelId:i,type:e.value}),window.channelNotifyType[r]=window.channelNotifyType[r]||{},window.channelNotifyType[r][i]=e.value):(Ge.emit("setGroupNotifyType",{groupId:r,type:e.value}),window.groupNotifyType[r]=e.value),a.remove();const n=document.getElementById("channel"===t?"channelContextMenu":"groupContextMenu");n&&n.remove(),window.openNotifyTarget=null,window.openNotifyType=null})),a.appendChild(n)})),document.body.appendChild(a);const s=t=>{const n=t.relatedTarget;e.contains(n)||a.contains(n)||(a.remove(),e.removeEventListener("mouseleave",s),a.removeEventListener("mouseleave",s))};e.addEventListener("mouseleave",s),a.addEventListener("mouseleave",s),document.addEventListener("click",(function e(){const t=document.getElementById("notifySubMenu");t&&t.remove(),window.openNotifyTarget=null,window.openNotifyType=null,document.removeEventListener("click",e)}))}window.leaveRoomInternal=function(...e){return window.channelAreaResizeObserver&&(window.channelAreaResizeObserver.disconnect(),window.channelAreaResizeObserver=null),window.channelAreaResizeHandler&&(window.removeEventListener("resize",window.channelAreaResizeHandler),window.channelAreaResizeHandler=null),In.apply(this,e)},["device","deviceIsLoaded","sendTransport","recvTransport","localStream","audioPermissionGranted","localProducer","consumers","remoteAudios","screenShareVideo","screenShareContainer"].forEach((e=>{Object.defineProperty(window,e,{get:()=>r[e],set(t){"screenShareVideo"===e?M(t):"screenShareContainer"===e?T(t):r[e]=t}})})),Object.assign(window,{selectedGroup:qe,currentGroup:null,currentRoom:null,currentTextChannel:null,currentRoomType:null,activeVoiceChannelName:"",activeVoiceGroupName:"",micEnabled:!0,selfDeafened:!1,micWasEnabledBeforeDeaf:!1,hasMic:!0}),window.applyAudioStates=e=>{e||(e={localProducer:S,localStream:I,socket:Ge,micEnabled:window.micEnabled,selfDeafened:window.selfDeafened,micToggleButton:qt,deafenToggleButton:Rt,remoteAudios:b,hasMic:window.hasMic}),function({localProducer:e,localStream:t,socket:n,micEnabled:a,selfDeafened:o,micToggleButton:r,deafenToggleButton:i,remoteAudios:d,hasMic:s}){if(e)if(a&&!o)e.resume(),g[n.id]||y(t,n.id);else{e.pause(),h(n.id);const t=document.getElementById(`avatar-${n.id}`);t&&t.classList.remove("speaking")}const l=[i];[r].forEach((e=>{e&&(!a||o?(e.innerHTML='<span class="material-icons">mic_off</span>',e.classList.add("btn-muted","muted")):(e.innerHTML='<span class="material-icons">mic</span>',e.classList.remove("btn-muted","muted")))})),l.forEach((e=>{e&&(o?(e.innerHTML='<span class="material-icons">headset_off</span>',e.classList.add("btn-muted","muted")):(e.innerHTML='<span class="material-icons">headset</span>',e.classList.remove("btn-muted","muted")))})),d.forEach((e=>{e.muted=o})),n.emit("audioStateChanged",{micEnabled:a,selfDeafened:o,hasMic:s})}(e)},window.addEventListener("DOMContentLoaded",(()=>{yt.querySelector(".material-icons").textContent="forum",Bt();const e=window.SOCKET_URL||window.location.origin,t=(()=>{try{return localStorage.getItem("token")}catch(e){return null}})();Ge=io(e,{transports:["websocket"],auth:t?{token:t}:{}}),Ie(Ge),(0,ae.fF)(Ge),ne(Ge,(()=>function(e,t,n,a){const o=t.value.trim(),r=n.value.trim();if(a.style.display="none",t.classList.remove("shake"),n.classList.remove("shake"),!o||!r)return a.textContent="Lütfen gerekli alanları doldurunuz",a.style.display="block",t.classList.add("shake"),void n.classList.add("shake");e.emit("login",{username:o,password:r})}(Ge,ze,He,_e)),(()=>function(e,t){const{regUsernameInput:n,regNameInput:a,regSurnameInput:o,regBirthdateInput:r,regEmailInput:i,regPhoneInput:s,regPasswordInput:l,regPasswordConfirmInput:c,registerErrorMessage:u}=t;d.info("🔐 attemptRegister tetiklendi");const m=n.value.trim(),p=a.value.trim(),w=o.value.trim(),g=r.value.trim(),y=i.value.trim(),h=s.value.trim(),f=l.value.trim(),v=c.value.trim();return u.style.display="none",[n,l,c].forEach((e=>e.classList.remove("shake"))),m&&p&&w&&g&&y&&h&&f&&v?m!==m.toLowerCase()?(u.textContent="Kullanıcı adı sadece küçük harf olmalı!",u.style.display="block",void n.classList.add("shake")):f!==v?(u.textContent="Parolalar eşleşmiyor!",u.style.display="block",l.classList.add("shake"),void c.classList.add("shake")):/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/.test(f)?void e.emit("register",{username:m,name:p,surname:w,birthdate:g,email:y,phone:h,password:f,passwordConfirm:v}):(u.textContent="Parola en az 8 karakter, büyük/küçük harf, rakam ve özel karakter içermeli.",u.style.display="block",void l.classList.add("shake")):(u.textContent="Lütfen tüm alanları doldurunuz.",void(u.style.display="block"))}(Ge,{regUsernameInput:Ve,regNameInput:Fe,regSurnameInput:We,regBirthdateInput:Ye,regEmailInput:Ke,regPhoneInput:Je,regPasswordInput:Xe,regPasswordConfirmInput:Qe,registerErrorMessage:tt}))),function(e,t,n){const a=document.getElementById("textChannelMessageInput");if(!a)return void console.error("Text chat input field (id='textChannelMessageInput') bulunamadı!");let o=document.getElementById("typingIndicator");o||(o=document.createElement("div"),o.id="typingIndicator",o.classList.add("typing-indicator"),o.style.position="absolute",o.style.top="calc(100% + 5px)",o.style.left="10px",o.style.fontSize="0.9em",o.style.color="#aaa",o.style.visibility="hidden",o.setAttribute("data-channel",t()),a.parentElement.appendChild(o));let r=new Set;function i(){if(r.size>0){const e=Array.from(r).join(", ");o.textContent=e+" yazıyor...",o.style.visibility="visible"}else o.textContent="",o.style.visibility="hidden"}e.on("typing",(e=>{e.channel===t()&&e.username!==n()&&(r.add(e.username),i())})),e.on("stop typing",(e=>{e.channel===t()&&e.username!==n()&&(r.delete(e.username),i())}));let d=null;a.addEventListener("input",(()=>{o.setAttribute("data-channel",t()),""!==(void 0!==a.value?a.value:a.innerText).trim()?(e.emit("typing",{username:n(),channel:t()}),d||(d=setInterval((()=>{""!==(void 0!==a.value?a.value:a.innerText).trim()?e.emit("typing",{username:n(),channel:t()}):(clearInterval(d),d=null,e.emit("stop typing",{username:n(),channel:t()}))}),2e3))):(d&&(clearInterval(d),d=null),e.emit("stop typing",{username:n(),channel:t()}))})),setInterval((function(){const e=t();o.getAttribute("data-channel")!==e&&(o.setAttribute("data-channel",e),r.clear(),i())}),500),e.on("updateCurrentChannel",(e=>{e&&e.channel&&(o.setAttribute("data-channel",e.channel),r.clear(),i())})),document.addEventListener("channelChanged",(e=>{e.detail&&e.detail.newChannel&&(o.setAttribute("data-channel",e.detail.newChannel),r.clear(),i())}))}(Ge,(()=>window.currentTextChannel),(()=>window.username)),function(e){function t(){document.querySelectorAll(".dm-friends-button.selected").forEach((e=>e.classList.remove("selected"))),document.querySelectorAll(".dm-content-item.selected").forEach((e=>e.classList.remove("selected")))}e.on("friendListUpdated",(()=>{const e=document.getElementById("dmPanel");window.isDMMode&&e&&"none"!==e.style.display&&d()}));const n=document.getElementById("dmChannelTitle");if(!n)return void console.error("dmChannelTitle not found");function a(){let e=document.getElementById("dmContentArea");if(!e){e=document.createElement("div"),e.id="dmContentArea",e.className="text-channel-container";const t=document.getElementById("selectedDMBar");t?t.parentNode.insertBefore(e,t.nextSibling):n.parentNode.insertBefore(e,n.nextSibling)}return e}function r(e){const t=document.createElement("div");return t.className="dm-content-item",t.textContent=e,t}document.addEventListener("click",(function(n){if(n.target.closest("#dmChannelTitle")&&n.target.classList.contains("dm-filter-item")){t();const i=n.target.getAttribute("data-filter"),d=a();if(d.style.display="block",d.innerHTML="","add"===i){const s=document.createElement("input");s.type="text",s.id="friendSearchInput",s.placeholder="Kullanıcı adı girin...",s.className="dm-search-input";const l=document.createElement("button");function c(){const t=s.value.trim();""!==t&&e.emit("sendFriendRequest",{to:t},(e=>{e.success?(alert("Arkadaşlık isteği gönderildi."),s.value=""):alert("İstek gönderilemedi: "+e.message)}))}l.textContent="Arkadaşlık İsteği Gönder",l.id="sendFriendRequestButton",l.className="dm-send-request-btn",d.appendChild(s),d.appendChild(l),l.addEventListener("click",c),s.addEventListener("keydown",(e=>{"Enter"===e.key&&c()}))}else"sent"===i?e.emit("getPendingFriendRequests",{},(t=>{e.emit("getOutgoingFriendRequests",{},(n=>{const a=document.createElement("h3");if(a.textContent="Gelen Arkadaşlık İstekleri",d.appendChild(a),t.success&&Array.isArray(t.requests)&&t.requests.length>0){const n=document.createElement("ul");t.requests.forEach((t=>{const a=document.createElement("li");a.className="dm-content-item",a.textContent=t.from;const o=document.createElement("button");o.className="friend-accept-btn",o.innerHTML='<span class="material-icons" style="color: green;">check</span>',o.addEventListener("click",(()=>{e.emit("acceptFriendRequest",{from:t.from},(e=>{e.success?(alert("Arkadaşlık isteği kabul edildi."),a.remove()):alert("İstek kabul edilemedi: "+e.message)}))}));const r=document.createElement("button");r.className="friend-reject-btn",r.innerHTML='<span class="material-icons" style="color: red;">close</span>',r.addEventListener("click",(()=>{e.emit("rejectFriendRequest",{from:t.from},(e=>{e.success?(alert("Arkadaşlık isteği reddedildi."),a.remove()):alert("İstek reddedilemedi: "+e.message)}))})),a.appendChild(o),a.appendChild(r),n.appendChild(a)})),d.appendChild(n)}else d.appendChild(r("Gelen arkadaşlık isteği bulunmuyor."));const o=document.createElement("h3");if(o.textContent="Gönderilen Arkadaşlık İstekleri",d.appendChild(o),n.success&&Array.isArray(n.requests)&&n.requests.length>0){const e=document.createElement("ul");n.requests.forEach((t=>{const n=document.createElement("li");n.className="dm-content-item",n.textContent=`To: ${t.to}`,e.appendChild(n)})),d.appendChild(e)}else d.appendChild(r("Gönderilen arkadaşlık isteği bulunmuyor."))}))})):"all"===i?e.emit("getFriendsList",{},(n=>{n.success&&Array.isArray(n.friends)?0===n.friends.length?d.appendChild(r("Hiç arkadaşınız yok.")):n.friends.forEach((n=>{const a=document.createElement("div");a.className="dm-content-item",a.textContent=n.username,a.addEventListener("click",(()=>{t(),a.classList.add("selected");const r=document.getElementById("selectedDMBar");if(r){r.innerHTML="";const e=document.createElement("h2");e.id="dmChannelTitle",e.className="dm-channel-title",e.textContent=n.username,r.appendChild(e)}o.e(774).then(o.bind(o,774)).then((t=>{t.initDMChat(e,n.username)})).catch((e=>console.error(e)))})),d.appendChild(a)})):d.appendChild(r("Arkadaşlar alınırken hata oluştu."))})):"online"===i?e.emit("getFriendsList",{},(n=>{if(n.success&&Array.isArray(n.friends))if(0===n.friends.length)d.appendChild(r("Hiç arkadaşınız yok."));else{const a=n.friends.filter((e=>e.online));0===a.length?d.appendChild(r("Çevrimiçi hiç arkadaşınız yok.")):a.forEach((n=>{const a=document.createElement("div");a.className="dm-content-item",a.textContent=n.username,a.addEventListener("click",(()=>{t(),a.classList.add("selected");const r=document.getElementById("selectedDMBar");if(r){r.innerHTML="";const e=document.createElement("h2");e.id="dmChannelTitle",e.className="dm-channel-title",e.textContent=n.username,r.appendChild(e)}o.e(774).then(o.bind(o,774)).then((t=>{t.initDMChat(e,n.username)})).catch((e=>console.error(e)))})),d.appendChild(a)}))}else d.appendChild(r("Arkadaşlar alınırken hata oluştu."))})):"blocked"===i&&e.emit("getBlockedFriends",{},(n=>{n.success&&Array.isArray(n.friends)?0===n.friends.length?d.appendChild(r("Engellenen arkadaş bulunmuyor.")):n.friends.forEach((n=>{const a=document.createElement("div");a.className="dm-content-item",a.textContent=n.username,a.addEventListener("click",(()=>{t(),a.classList.add("selected");const r=document.getElementById("selectedDMBar");if(r){r.innerHTML="";const e=document.createElement("h2");e.id="dmChannelTitle",e.className="dm-channel-title",e.textContent=n.username,r.appendChild(e)}o.e(774).then(o.bind(o,774)).then((t=>{t.initDMChat(e,n.username)})).catch((e=>console.error(e)))})),d.appendChild(a)})):d.appendChild(r("Engellenen arkadaşlar alınırken hata oluştu."))}))}}));const i=document.getElementById("toggleDMButton");function d(){const n=document.getElementById("dmPanel");if(!n)return void console.error("dmPanel not found");n.style.padding="0",n.innerHTML="";const r=document.createElement("div");r.className="dm-panel-header",n.appendChild(r);const i=document.createElement("input");i.type="text",i.placeholder="Bir konuşma bulun veya başlatın...",i.className="dm-search-input",i.addEventListener("input",(function(){const e=i.value.toLowerCase();n.querySelectorAll(".dm-friend-item").forEach((t=>{t.textContent.toLowerCase().indexOf(e)>-1?t.style.display="block":t.style.display="none"}))})),r.appendChild(i),n.appendChild(r);const d=document.createElement("button");d.innerHTML='<span class="material-icons dm-group-icon">group</span>Arkadaşlar',d.className="dm-friends-button",d.addEventListener("click",(()=>{t(),d.classList.add("selected");const e=document.getElementById("selectedDMBar");if(e){e.innerHTML="";const t=document.createElement("h2");t.id="dmChannelTitle",t.className="dm-channel-title",t.innerHTML='\n      <span class="dm-title-text">Arkadaşlar</span>\n      <span class="dm-divider"></span>\n      <span class="dm-filter-item" data-filter="online">Çevrimiçi</span>\n      <span class="dm-filter-item" data-filter="all">Hepsi</span>\n      <span class="dm-filter-item" data-filter="sent">Beklemede</span>\n      <span class="dm-filter-item" data-filter="blocked">Engellenen</span>\n      <span class="dm-filter-item" data-filter="add">Arkadaş ekle</span>\n    ',e.appendChild(t)}a().innerHTML=""})),n.appendChild(d),e.emit("getFriendsList",{},(a=>{if(a.success&&Array.isArray(a.friends))if(0===a.friends.length){const e=document.createElement("div");e.textContent="Hiç arkadaşınız yok.",e.style.padding="10px",n.appendChild(e)}else a.friends.forEach((a=>{const r=function(e){const t=document.createElement("div");t.classList.add("user-item","dm-friend-item"),t.style.cursor="pointer";const n=document.createElement("img");n.classList.add("user-profile-pic"),n.src="/images/default-avatar.png",n.alt="";const a=document.createElement("span");return a.classList.add("user-name"),a.textContent=e,a.style.marginLeft="8px",t.appendChild(n),t.appendChild(a),t}(a.username);r.addEventListener("click",(()=>{t(),r.classList.add("selected");const n=document.getElementById("selectedDMBar");if(n){n.innerHTML="";const e=document.createElement("h2");e.id="dmChannelTitle",e.className="dm-channel-title",e.textContent=a.username,n.appendChild(e)}o.e(774).then(o.bind(o,774)).then((t=>{t.initDMChat(e,a.username)})).catch((e=>console.error(e)))})),n.appendChild(r)}));else n.textContent="Arkadaşlar alınırken hata oluştu."}))}i&&i.addEventListener("click",(()=>{t(),d()}))}(Ge),Ue(),function(){const e=document.getElementById("attachBtn"),t=document.getElementById("attachmentPreview");_=document.getElementById("previewWrapper");const n=_?.querySelector(".main-media"),a=_?.querySelector(".thumbnail-tray");V=_?.querySelector(".caption-input");const o=_?.querySelector(".close-icon"),r=document.getElementById("textChannelContainer"),i={file:document.getElementById("attachFileInput"),media:document.getElementById("attachMediaInput"),audio:document.getElementById("attachAudioInput"),gif:document.getElementById("attachGifInput")};if(!e||!t)return;let d=null;function s(){t.innerHTML="",H.forEach(((e,n)=>{const a=document.createElement("div");let o;a.className="preview-item",a.dataset.index=n,a.tabIndex=0,e.file.type.startsWith("image/")?(o=document.createElement("img"),o.src=URL.createObjectURL(e.file)):e.file.type.startsWith("video/")?(o=document.createElement("span"),o.className="material-icons",o.textContent="movie"):e.file.type.startsWith("audio/")?(o=document.createElement("span"),o.className="material-icons",o.textContent="audiotrack"):(o=document.createElement("span"),o.className="material-icons",o.textContent="insert_drive_file"),a.appendChild(o);const r=document.createElement("span");r.className="remove-badge material-icons",r.textContent="close",r.addEventListener("click",(()=>{H.splice(n,1),s()})),a.appendChild(r);const i=document.createElement("div");i.className="upload-progress";const d=document.createElement("div");d.className="bar",i.appendChild(d),a.appendChild(i);const l=document.createElement("button");l.className="retry-btn",l.textContent="↻",l.style.display="none",a.appendChild(l),t.appendChild(a)})),t.style.display=H.length?"flex":"none",H.length&&!j?(j=function(n){const a=t.contains(n.target),o=_&&_.contains(n.target);a||o||n.target===e||(W(),document.removeEventListener("click",j),j=null)},document.addEventListener("click",j)):!H.length&&j&&(document.removeEventListener("click",j),j=null),_&&"none"!==_.style.display&&c()}function l(e,t){const n=document.createElement("div");n.className="file-card";const a=document.createElement("span");a.textContent=e.file.name,n.appendChild(a);const o=document.createElement("span");return o.className="remove-btn",o.textContent="×",o.addEventListener("click",(e=>{e.stopPropagation(),H.splice(t,1),O>=t&&(O=Math.max(O-1,0)),s(),c()})),n.appendChild(o),n}function c(){_&&(a.innerHTML="",H.slice(0,10).forEach(((e,t)=>{let n;e.file.type.startsWith("image/")?(n=document.createElement("img"),n.src=URL.createObjectURL(e.file)):e.file.type.startsWith("video/")?(n=document.createElement("video"),n.src=URL.createObjectURL(e.file),n.muted=!0):n=l(e,t),n.dataset.index=t,n.addEventListener("click",(()=>{O=t,u()})),a.appendChild(n)})),H.length?u():p())}function u(){if(!_)return;n.innerHTML="";const e=H[O];if(!e)return;let t;if(e.file.type.startsWith("image/"))t=document.createElement("img"),t.src=URL.createObjectURL(e.file);else if(e.file.type.startsWith("video/")){t=document.createElement("video"),t.controls=!0;const n=document.createElement("source");n.src=URL.createObjectURL(e.file),n.type=e.file.type,t.appendChild(n)}else t=l(e,O);n.appendChild(t)}function m(){if(!_)return;const e=document.getElementById("textMessages");O=0,c(),_.style.display="flex",e&&(e.style.display="none"),V&&V.focus();const t=document.getElementById("sendTextMessageBtn");t&&(t.style.display="block");const n=document.getElementById("micMessageBtn");n&&(n.style.display="none")}function p(){if(!_)return;_.style.display="none";const e=document.getElementById("textMessages");e&&(e.style.display="");const t=document.getElementById("textChannelMessageInput"),n=document.getElementById("sendTextMessageBtn"),a=document.getElementById("micMessageBtn");t&&n&&a&&(""===(0,z.os)(t).trim()?(n.style.display="none",a.style.display="block"):(n.style.display="block",a.style.display="none"))}function w(){d&&(d.remove(),document.removeEventListener("click",g),document.removeEventListener("keydown",y),d=null)}function g(t){d&&!d.contains(t.target)&&t.target!==e&&w()}function y(e){"Escape"===e.key&&w()}if(e.addEventListener("click",(t=>{t.stopPropagation(),function(){if(d)return void w();d=document.createElement("div"),d.id="attachmentMenu",d.className="context-menu",["file","media","audio","gif"].forEach((e=>{const t=document.createElement("div");t.className="context-menu-item",t.textContent=e,t.addEventListener("click",(()=>{i[e].click(),w()})),d.appendChild(t)}));const t=e.getBoundingClientRect();d.style.left=t.left+"px",d.style.bottom=window.innerHeight-t.top+8+"px",d.style.display="flex",document.body.appendChild(d),document.addEventListener("click",g),document.addEventListener("keydown",y)}()})),Object.keys(i).forEach((e=>{const t=i[e];t.addEventListener("change",(n=>{const a=Array.from(n.target.files),o=10-H.length;a.slice(0,o).forEach((t=>H.push({file:t,type:e}))),a.length>o&&alert("En fazla 10 dosya ekleyebilirsiniz."),t.value="",s(),m()}))})),r){const e=e=>e.preventDefault();r.addEventListener("dragenter",e),r.addEventListener("dragover",e),r.addEventListener("drop",(e=>{e.preventDefault();const t=e.dataTransfer;if(t&&t.files&&t.files.length){const e=Array.from(t.files),n=10-H.length;e.slice(0,n).forEach((e=>H.push({file:e,type:"file"}))),e.length>n&&alert("En fazla 10 dosya ekleyebilirsiniz."),s(),m()}}))}document.addEventListener("keydown",(e=>{const n=Array.from(t.querySelectorAll(".preview-item"));if(!e.altKey||"ArrowUp"!==e.key&&"ArrowDown"!==e.key)if("Delete"===e.key){const e=n.indexOf(document.activeElement);if(-1!==e){H.splice(e,1),s();const t=n[e]||n[e-1];t&&t.focus()}}else"Escape"===e.key&&(_&&"none"!==_.style.display?p():(w(),H.length&&W()));else{if(!n.length)return;e.preventDefault();let t=n.indexOf(document.activeElement);-1===t&&(t=0),t="ArrowDown"===e.key?(t+1)%n.length:(t-1+n.length)%n.length,n[t].focus()}})),o&&o.addEventListener("click",p)}();const n=(()=>{try{return localStorage.getItem("username")}catch(e){return null}})();n&&(window.username=n,Re.style.display="none",$e.style.display="flex",t||Ge.emit("set-username",n),document.getElementById("userCardName").textContent=n,window.applyAudioStates(),window.loadAvatar(n).then((e=>{const t=document.getElementById("userCardAvatar");t&&(t.style.backgroundImage=`url(${e})`,t.dataset.username=n)})));const a=document.getElementById("channelContentArea"),r=()=>{"voice"===window.currentRoomType&&window.latestChannelsData&&window.latestChannelsData[window.currentRoom]&&window.renderVoiceChannelGrid(window.latestChannelsData[window.currentRoom].users)};a&&("ResizeObserver"in window?(window.channelAreaResizeObserver=new ResizeObserver(r),window.channelAreaResizeObserver.observe(a)):(window.channelAreaResizeHandler=r,window.addEventListener("resize",window.channelAreaResizeHandler)));const s=zt;let l;s&&s.addEventListener("scroll",(function(){s.scrollTop+s.clientHeight>=s.scrollHeight-5?l=setTimeout((()=>{s.scrollTop+s.clientHeight>=s.scrollHeight-5&&s.classList.remove("scrolling")}),1e3):(clearTimeout(l),s.classList.add("scrolling"))})),i.w(Ge,zt),document.addEventListener("click",(function(e){if(e.target&&e.target.classList.contains("dm-filter-item")){const t=e.target.getAttribute("data-filter");console.info("DM Filter clicked: "+t)}}))})),window.showMuteSubMenu=Ln,window.showNotificationSubMenu=Sn,window.showChannelContextMenu=function(e,t){const n=document.getElementById("channelContextMenu");n&&n.remove();const a=document.createElement("div");a.id="channelContextMenu",a.className="context-menu",a.style.position="absolute",a.style.top=e.pageY+"px",a.style.left=e.pageX+"px",a.style.display="flex",a.style.flexDirection="column";let o=0;window.latestChannelsData&&(o=Object.values(window.latestChannelsData).filter((e=>"text"===e.type)).length);const r=window.channelMuteUntil[window.selectedGroup]&&window.channelMuteUntil[window.selectedGroup][t.id];[{text:"Kanal Ayarları",action:()=>{alert("Kanal ayarları henüz uygulanmadı.")}},r&&Date.now()<r?{text:"Bu kanalın sesini aç",action:()=>{Ge.emit("muteChannel",{groupId:window.selectedGroup,channelId:t.id,duration:0})}}:{text:"Bu kanalı sessize al",mute:!0,action:()=>{}},{text:"Bildirim türü",notification:!0,action:()=>{}},{text:"Kanalın İsmini Değiştir",action:()=>{const e=prompt("Yeni kanal ismini girin:",t.name);e&&""!==e.trim()&&Ge.emit("renameChannel",{channelId:t.id,newName:e.trim()})}},{text:"Kanalı Sil",hide:"text"===t.type&&1===o,action:()=>{confirm("Bu kanalı silmek istediğinize emin misiniz?")&&Ge.emit("deleteChannel",t.id)}}].forEach((e=>{if(e.hide)return;const n=document.createElement("div");if(n.className="context-menu-item",e.mute){const a=document.createElement("span");a.textContent=e.text;const o=document.createElement("span");o.classList.add("material-icons"),o.textContent="chevron_right",n.appendChild(a),n.appendChild(o),n.dataset.channelId=t.id,n.addEventListener("mouseenter",(()=>Ln(n,"channel")))}else if(e.notification){const a=document.createElement("span");a.textContent=e.text;const o=document.createElement("span");o.classList.add("material-icons"),o.textContent="chevron_right",n.appendChild(a),n.appendChild(o),n.dataset.channelId=t.id,n.addEventListener("mouseenter",(()=>Sn(n,"channel")))}else n.textContent=e.text,n.addEventListener("click",(()=>{e.action(),a.remove()}));a.appendChild(n)})),document.body.appendChild(a),document.addEventListener("click",(function e(){document.getElementById("channelContextMenu")&&document.getElementById("channelContextMenu").remove(),document.removeEventListener("click",e)}))},window.showCategoryContextMenu=function(e,t){const n=document.getElementById("categoryContextMenu");n&&n.remove();const a=document.createElement("div");a.id="categoryContextMenu",a.className="context-menu",a.style.position="absolute",a.style.top=e.pageY+"px",a.style.left=e.pageX+"px",a.style.display="flex",a.style.flexDirection="column";const o=window.categoryMuteUntil[window.selectedGroup]&&window.categoryMuteUntil[window.selectedGroup][t.id];[{text:"Kategori ayarları",action:()=>{alert("Kategori ayarları henüz uygulanmadı.")}},o&&Date.now()<o?{text:"Bu kategorinin sesini aç",action:()=>{Ge.emit("muteCategory",{groupId:window.selectedGroup,categoryId:t.id,duration:0})}}:{text:"Bu kategoriyi sessize al",mute:!0,action:()=>{}},{text:"Bildirim türü",notification:!0,action:()=>{}},{text:"Kategorinin ismini değiştir",action:()=>{const e=prompt("Yeni kategori ismini girin:",t.name);e&&""!==e.trim()&&Ge.emit("renameCategory",{categoryId:t.id,newName:e.trim()})}},{text:"Kategoriyi sil",action:()=>{confirm("Bu kategoriyi silmek istediğinize emin misiniz?")&&Ge.emit("deleteCategory",t.id)}}].forEach((e=>{const n=document.createElement("div");if(n.className="context-menu-item",e.mute){const a=document.createElement("span");a.textContent=e.text;const o=document.createElement("span");o.classList.add("material-icons"),o.textContent="chevron_right",n.appendChild(a),n.appendChild(o),n.dataset.categoryId=t.id,n.addEventListener("mouseenter",(()=>Ln(n,"category")))}else if(e.notification){const t=document.createElement("span");t.textContent=e.text;const a=document.createElement("span");a.classList.add("material-icons"),a.textContent="chevron_right",n.appendChild(t),n.appendChild(a)}else n.textContent=e.text,n.addEventListener("click",(()=>{e.action(),a.remove()}));a.appendChild(n)})),document.body.appendChild(a),document.addEventListener("click",(function e(){const t=document.getElementById("categoryContextMenu");t&&t.remove(),document.removeEventListener("click",e)}))},window.showGroupContextMenu=function(e,t){const n=document.getElementById("groupContextMenu");n&&n.remove();const a=document.createElement("div");a.id="groupContextMenu",a.className="context-menu",a.style.position="absolute",a.style.top=e.pageY+"px",a.style.left=e.pageX+"px",a.style.display="flex",a.style.flexDirection="column";const o=window.groupMuteUntil[t.id];[{text:"Grup ID Kopyala",action:()=>navigator.clipboard.writeText(t.id)},o&&Date.now()<o?{text:"Bu grubun sesini aç",action:()=>{Ge.emit("muteGroup",{groupId:t.id,duration:0})}}:{text:"Bu grubu sessize al",mute:!0,action:()=>{}},{text:"Bildirim türü",notification:!0,action:()=>{}},{text:"Gruptan Ayrıl",hide:t.owner===window.username,action:()=>{Ge.emit("leaveGroup",t.id)}}].forEach((e=>{if(e.hide)return;const n=document.createElement("div");if(n.className="context-menu-item",e.mute){const a=document.createElement("span");a.textContent=e.text;const o=document.createElement("span");o.classList.add("material-icons"),o.textContent="chevron_right",n.appendChild(a),n.appendChild(o),n.dataset.groupId=t.id,n.addEventListener("mouseenter",(()=>Ln(n,"group")))}else if(e.notification){const a=document.createElement("span");a.textContent=e.text;const o=document.createElement("span");o.classList.add("material-icons"),o.textContent="chevron_right",n.appendChild(a),n.appendChild(o),n.dataset.groupId=t.id,n.addEventListener("mouseenter",(()=>Sn(n,"group")))}else n.textContent=e.text,n.addEventListener("click",(()=>{e.action(),a.remove()}));a.appendChild(n)})),document.body.appendChild(a),document.addEventListener("click",(function e(){const t=document.getElementById("groupContextMenu");t&&t.remove(),document.removeEventListener("click",e)}))},window.showVideoContextMenu=function(e){if(e.preventDefault(),!x)return;const t=document.getElementById("videoContextMenu");t&&t.remove();const n=document.createElement("div");n.id="videoContextMenu",n.className="context-menu",n.style.position="absolute",n.style.top=e.pageY+"px",n.style.left=e.pageX+"px",n.style.display="flex",n.style.flexDirection="column";const a=x.dataset.peerId,o=b.find((e=>e.dataset.peerId===a));if(o){const e=document.createElement("div");e.className="context-menu-item";const t=document.createElement("input");t.type="range",t.min="0",t.max="1",t.step="0.01",t.value=o.volume,t.addEventListener("input",(()=>{o.volume=parseFloat(t.value)})),e.textContent="Ses: ",e.appendChild(t),n.appendChild(e)}document.body.appendChild(n),document.addEventListener("click",(function e(){const t=document.getElementById("videoContextMenu");t&&t.remove(),document.removeEventListener("click",e)}))},window.updateVoiceChannelUI=function(e,t=!1){Vt.textContent=e;const n=document.getElementById("channelUsersContainer");n&&(n.style.display="grid"),$t.style.display="none",t?(Et&&(Et.style.display="flex"),xt()):Tt()},window.showScreenShare=function(e){$(Ge,null,null,e,De)},window.displayScreenShareEndedMessage=function(e){document.querySelector(".channel-content-area");let t=document.getElementById("screenShareEndedMessage");t||(t=document.createElement("div"),t.id="screenShareEndedMessage",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.color="#fff",t.style.backgroundColor="rgba(0,0,0,0.7)",t.style.padding="1rem",t.style.borderRadius="8px",t.style.fontSize="1.2rem"),t.textContent=e||"Bu yayın sonlandırıldı",document.querySelector(".channel-content-area").appendChild(t)},window.removeScreenShareEndedMessage=function(){const e=document.getElementById("screenShareEndedMessage");e&&e.parentNode&&e.parentNode.removeChild(e)},window.openUserSettings=function(){const e=document.getElementById("userSettingsPage"),t=document.getElementById("callScreen");e&&(e.style.display="block",Ue()),t&&(t.style.display="none")},window.closeUserSettings=Ne})();